<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Account • GCSE Focus</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b1020;
  --panel:rgba(255,255,255,.06);
  --panel-strong:rgba(255,255,255,.09);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.66);
  --border:rgba(255,255,255,.14);
  --accent:#8ea2ff;
  --danger:#ff4d4d;
  --radius:18px;
}

html[data-theme="light"]{
  --bg:#f5f7ff;
  --panel:rgba(0,0,0,.05);
  --panel-strong:rgba(0,0,0,.08);
  --text:rgba(0,0,0,.9);
  --muted:rgba(0,0,0,.6);
  --border:rgba(0,0,0,.12);
  --accent:#5b6cff;
  --danger:#d60000;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.wrap{
  max-width:900px;
  margin:40px auto;
  padding:20px;
}

.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:22px;
  margin-bottom:22px;
}

h1{margin:0;}
h2{margin-top:0;font-size:18px;}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:14px 0;
  gap:20px;
  flex-wrap:wrap;
}

.label{
  color:var(--muted);
  min-width:160px;
}

input[type="text"],
input[type="time"],
select{
  background:var(--panel-strong);
  color:var(--text);
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px 12px;
  outline:none;
}

select option{
  background:var(--bg);
  color:var(--text);
}

input:focus,
select:focus{
  border-color:var(--accent);
}

input[type="checkbox"]{
  width:18px;
  height:18px;
  accent-color:var(--accent);
  cursor:pointer;
}

.btn{
  padding:8px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--panel-strong);
  color:var(--text);
  cursor:pointer;
  transition:0.15s ease;
}

.btn:hover{
  background:var(--panel);
}

.btn.primary{
  background:var(--accent);
  color:white;
  border:none;
}

html[data-theme="light"] .btn.primary{
  color:white;
}

.btn.danger{
  background:rgba(255,0,0,.15);
  border:1px solid var(--danger);
  color:var(--danger);
}

.notice{
  font-size:13px;
  color:var(--muted);
  margin-top:6px;
}
</style>
</head>

<body>
<div class="wrap">

<div class="topbar">
  <h1>Account</h1>
  <div>
    <button class="btn" onclick="window.location.href='index.html'">← Back</button>
    <button class="btn" id="btnLogout">Logout</button>
  </div>
</div>

<div class="panel">
  <h2>Profile</h2>
  <div class="row">
    <span class="label">Username</span>
    <input type="text" id="usernameInput">
  </div>
  <div class="row">
    <span class="label">Email</span>
    <span id="email"></span>
  </div>
</div>

<div class="panel">
  <h2>Subscription</h2>
  <div class="row">
    <span class="label">Account type</span>
    <span>Student</span>
  </div>
  <div class="row">
    <span class="label">Subscription type</span>
    <span id="tier">Free</span>
  </div>
  <div class="row">
    <span class="label">Payment</span>
    <button class="btn">Manage</button>
  </div>
</div>

<div class="panel">
  <h2>Appearance</h2>
  <div class="row">
    <span class="label">Theme</span>
    <select id="themeSelect">
      <option value="auto">Auto</option>
      <option value="dark">Dark</option>
      <option value="light">Light</option>
    </select>
  </div>
</div>

<div class="panel">
  <h2>Notifications</h2>
  <div class="row">
    <span class="label">Study reminders</span>
    <input type="time" id="reminderTime">
  </div>
  <div class="row">
    <span class="label">Email updates</span>
    <input type="checkbox" id="notifyUpdates">
  </div>
  <div class="row">
    <span class="label">Promotions</span>
    <input type="checkbox" id="notifyPromos">
  </div>
</div>

<div class="panel">
  <h2>Security</h2>
  <button class="btn primary" id="btnChangePassword">Request Password Reset</button>
  <button class="btn danger" id="btnDeleteAccount">Delete Account</button>
</div>

</div>

<script>
const supabaseClient = supabase.createClient(
  "https://mgpwknnbhaljsscsvucm.supabase.co",
  "sb_publishable_6tdnozSH6Ck75uDgXPN-sg_Mn7vyLFs"
);

async function saveSettings(updates, userId){
  await supabaseClient
    .from("user_settings")
    .update(updates)
    .eq("user_id", userId);
}

async function init(){
  const { data:{ session } } = await supabaseClient.auth.getSession();
  if(!session){
    window.location.href="auth.html";
    return;
  }

  const userId = session.user.id;
  document.getElementById("email").textContent = session.user.email;

  const { data } = await supabaseClient
    .from("user_settings")
    .select("*")
    .eq("user_id", userId)
    .single();

  if(data){
    document.getElementById("usernameInput").value = data.username || "";
    document.getElementById("tier").textContent = data.tier || "Free";
    document.getElementById("themeSelect").value = data.preferred_theme || "auto";
    document.getElementById("reminderTime").value = data.reminder_time || "08:00";
    document.getElementById("notifyUpdates").checked = data.notify_updates ?? true;
    document.getElementById("notifyPromos").checked = data.notify_promos ?? false;

    applyTheme(data.preferred_theme || "auto");
  }

  document.getElementById("usernameInput")
    .addEventListener("change", async (e)=>{
      const newUsername = e.target.value.trim();
      if(!newUsername) return;

      const { data:existing } = await supabaseClient
        .from("user_settings")
        .select("id")
        .eq("username", newUsername)
        .neq("user_id", userId)
        .maybeSingle();

      if(existing){
        alert("Username already in use.");
        return;
      }

      await saveSettings({ username:newUsername }, userId);
      alert("Username updated");
  });

  document.getElementById("themeSelect")
    .addEventListener("change", async (e)=>{
      const value = e.target.value;
      applyTheme(value);
      await saveSettings({ preferred_theme:value }, userId);
  });

  document.getElementById("reminderTime")
    .addEventListener("change", e=>{
      saveSettings({ reminder_time:e.target.value }, userId);
  });

  document.getElementById("notifyUpdates")
    .addEventListener("change", e=>{
      saveSettings({ notify_updates:e.target.checked }, userId);
  });

  document.getElementById("notifyPromos")
    .addEventListener("change", e=>{
      saveSettings({ notify_promos:e.target.checked }, userId);
  });

  document.getElementById("btnChangePassword")
    .addEventListener("click", async ()=>{
      await supabaseClient.auth.resetPasswordForEmail(session.user.email);
      alert("Password reset email sent.");
  });

  document.getElementById("btnLogout")
    .addEventListener("click", async ()=>{
      await supabaseClient.auth.signOut();
      window.location.href="auth.html";
  });

  document.getElementById("btnDeleteAccount")
    .addEventListener("click", ()=>{
      alert("Account deletion must be implemented securely via server.");
  });
}

function applyTheme(value){
  if(value==="auto"){
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    document.documentElement.setAttribute("data-theme", prefersDark?"dark":"light");
  } else {
    document.documentElement.setAttribute("data-theme", value);
  }
}

init();
</script>

</body>
</html>