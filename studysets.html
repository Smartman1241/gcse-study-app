<!doctype html>
<html lang="en" data-theme="dark">
<head>
<script src="theme.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReviseFlow ‚Äî Study Sets</title>
  <meta name="description" content="ReviseFlow Study Sets ‚Äî create, search, and manage revision sets. Saved to your account." />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.09);
      --border:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.66);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius:18px;

      --brand:#8ea2ff;
      --good:#46e6b3;
      --warn:#ffd36e;
      --danger:#ff5b6e;

      --btn:rgba(255,255,255,.10);
      --btn2:rgba(255,255,255,.14);
      --focus:rgba(142,162,255,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 12% 10%, rgba(142,162,255,.25),transparent 60%),
        radial-gradient(900px 600px at 86% 22%, rgba(70,230,179,.18),transparent 55%),
        radial-gradient(900px 600px at 75% 95%, rgba(255,211,110,.14),transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
      overflow-x:hidden;
    }

    a{color:inherit; text-decoration:none}
    button, input, textarea{font:inherit; color:inherit}

    .wrap{max-width:1180px; margin:0 auto; padding:22px 16px 44px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;
      margin-bottom:14px;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(142,162,255,.9), rgba(70,230,179,.75));
      box-shadow: 0 14px 35px rgba(0,0,0,.18);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.65), transparent 55%);
      transform: rotate(12deg);
    }
    .titleBlock{display:flex; flex-direction:column; gap:2px;}
    .titleBlock h1{margin:0; font-size:18px; letter-spacing:.2px; display:flex; align-items:center; gap:10px;}
    .badgeTiny{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(142,162,255,.35);
      background:rgba(142,162,255,.12);
      color:rgba(255,255,255,.86);
      font-weight:800;
    }
    .subtitle{font-size:13px; color:var(--muted);}

    .toolbar{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }

    .chip{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      background:var(--panel); border:1px solid var(--border);
      box-shadow: 0 10px 26px rgba(0,0,0,.08);
    }
    .chip small{color:var(--muted);}
    .chip b{font-weight:800;}

    .btn{
      border:1px solid var(--border);
      background:var(--btn);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{background:var(--btn2);}
    .btn:active{transform:translateY(1px);}
    .btn:disabled{opacity:.55; cursor:not-allowed;}
    .btn.primary{
      background: linear-gradient(135deg, rgba(142,162,255,.85), rgba(70,230,179,.65));
      border-color:transparent;
      color: rgba(10,16,32,.95);
      font-weight:850;
    }
    .btn.danger{
      background:rgba(255,91,110,.14);
      border-color:rgba(255,91,110,.28);
      color:#ffd2d8;
    }
    .btn.ghost{background:transparent;}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1.6fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, var(--panel2), transparent);
    }
    .panelHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.25px;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:900;
    }
    .panelBody{padding:14px;}

    .field{display:flex; flex-direction:column; gap:6px; margin-top:10px;}
    .label{font-size:12px; color:var(--muted); font-weight:700;}
    input[type="text"], textarea{
      width:100%;
      background: rgba(0,0,0,0);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
    }
    textarea{min-height:92px; resize:vertical;}
    input:focus, textarea:focus{
      border-color: rgba(142,162,255,.55);
      box-shadow: 0 0 0 4px var(--focus);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .divider{height:1px; background:var(--border); margin:12px 0;}
    .muted{color:var(--muted);}
    .small{font-size:12px;}

    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:none;
    }
    .msg.show{display:block;}
    .msg.ok{color:rgba(255,255,255,.78);}
    .msg.err{color:#ffd2d8; border-color:rgba(255,91,110,.28); background:rgba(255,91,110,.10);}

    .sets{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .set-card{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background: rgba(255,255,255,.04);
      transition: transform .12s ease, background .12s ease;
    }
    .set-card:hover{
      transform: translateY(-2px);
      background: rgba(255,255,255,.06);
    }

    .set-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }

    .set-name{
      font-weight:950;
      font-size:15px;
      line-height:1.25;
      word-break:break-word;
    }
    .badge{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      background:rgba(142,162,255,.18);
      border:1px solid rgba(142,162,255,.25);
      color:rgba(255,255,255,.88);
      white-space:nowrap;
      font-weight:800;
    }
    .desc{
      margin-top:8px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
      white-space:pre-wrap;
    }
    .actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn.small{padding:8px 10px; font-size:13px; font-weight:800;}
    .btn.primary.small{color: rgba(10,16,32,.95);}

    .empty{
      margin-top:14px;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
      background: rgba(255,255,255,.03);
    }

    .skeleton{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
      position:relative;
    }
    .skeleton:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
      transform: translateX(-100%);
      animation: shimmer 1.1s infinite;
    }
    @keyframes shimmer{
      100%{ transform: translateX(100%); }
    }

    .topSearch{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .topSearch input{flex:1; min-width: 220px;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" title="ReviseFlow"></div>
        <div class="titleBlock">
          <h1>Study Sets <span class="badgeTiny">ReviseFlow</span></h1>
          <div class="subtitle">Create sets once, then revise them with flashcards, learn, and tests.</div>
        </div>
      </div>

      <div class="toolbar">
        <a class="btn" href="dashboard.html">‚Üê Dashboard</a>
        <a class="btn" href="tasks.html">Tasks</a>
        <a class="btn" href="flashcards.html">Flashcards</a>
        <button class="btn danger" id="btnLogout">Logout</button>

        <div class="chip" title="Signed in user">
          <small>üë§</small>
          <b id="who">Loading‚Ä¶</b>
        </div>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT: CREATE -->
      <section class="panel">
        <div class="panelHeader">
          <div>
            <h2>Create set</h2>
            <div class="muted small">Tip: ‚ÄúBiology ‚Äî Cells‚Äù or ‚ÄúMacbeth ‚Äî Quotes‚Äù.</div>
          </div>
        </div>

        <div class="panelBody">
          <div class="field">
            <div class="label">Set name</div>
            <input id="setName" type="text" placeholder="e.g. Biology ‚Äî Cells" maxlength="120" />
          </div>

          <div class="field">
            <div class="label">Subject</div>
            <input id="setSubject" type="text" placeholder="e.g. Biology" maxlength="80" />
          </div>

          <div class="field">
            <div class="label">Description (optional)</div>
            <textarea id="setDesc" placeholder="What‚Äôs inside this set?" maxlength="500"></textarea>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn primary" id="btnCreate">Create set</button>
            <button class="btn" id="btnClear" type="button">Clear</button>
          </div>

          <div class="msg" id="createMsg"></div>

          <div class="divider"></div>
          <div class="muted small">
            Your sets are saved to your account in Supabase.
          </div>
        </div>
      </section>

      <!-- RIGHT: LIST -->
      <section class="panel">
        <div class="panelHeader">
          <div>
            <h2>Your sets</h2>
            <div class="muted small">Search, open, edit, or delete.</div>
          </div>
          <div class="row">
            <button class="btn" id="btnRefresh" type="button">Refresh</button>
          </div>
        </div>

        <div class="panelBody">
          <div class="topSearch">
            <input id="search" type="text" placeholder="Search sets‚Ä¶" />
          </div>

          <div class="sets" id="setsList"></div>

          <div class="empty" id="emptyHint" style="display:none;">
            No study sets yet ‚Äî create your first one on the left.
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
  // Supabase client (same keys you used)
  if (!window.supabaseClient) {
    window.supabaseClient = window.supabase.createClient(
      "https://mgpwknnbhaljsscsvucm.supabase.co",
      "sb_publishable_6tdnozSH6Ck75uDgXPN-sg_Mn7vyLFs"
    );
  }

  let currentUser = null;
  let allSets = [];

  const $ = (id) => document.getElementById(id);

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function showMsg(text, isError=false){
    const box = $("createMsg");
    box.textContent = text;
    box.classList.add("show");
    box.classList.toggle("err", !!isError);
    box.classList.toggle("ok", !isError);
  }

  function clearMsg(){
    const box = $("createMsg");
    box.classList.remove("show","err","ok");
    box.textContent = "";
  }

  async function requireSession(){
    const { data:{ session }, error } = await window.supabaseClient.auth.getSession();
    if (error) console.error(error);
    if (!session){
      window.location.href = "auth.html";
      return null;
    }
    return session;
  }

  function setLoadingList(loading){
    const list = $("setsList");
    if (!list) return;
    if (loading){
      list.innerHTML = `
        <div class="skeleton" style="height:86px;"></div>
        <div class="skeleton" style="height:86px;"></div>
        <div class="skeleton" style="height:86px;"></div>
      `;
    } else {
      // renderSets will replace
    }
  }

  async function init(){
    const session = await requireSession();
    if(!session) return;

    currentUser = session.user;
    $("who").textContent = currentUser.email || "Signed in";

    window.supabaseClient.auth.onAuthStateChange((_event, sess) => {
      if(!sess) window.location.href = "auth.html";
    });

    $("btnLogout").addEventListener("click", async () => {
      await window.supabaseClient.auth.signOut();
      window.location.href = "auth.html";
    });

    wireUI();
    await loadSets();
  }

  function wireUI(){
    $("btnCreate").addEventListener("click", createSet);
    $("btnClear").addEventListener("click", clearForm);
    $("btnRefresh").addEventListener("click", loadSets);
    $("search").addEventListener("input", renderSets);

    // Enter to create set from name field
    $("setName").addEventListener("keydown", (e) => {
      if (e.key === "Enter") createSet();
    });
  }

  function clearForm(){
    $("setName").value = "";
    $("setSubject").value = "";
    $("setDesc").value = "";
    clearMsg();
    $("setName").focus();
  }

  async function loadSets(){
    $("btnRefresh").disabled = true;
    setLoadingList(true);

    const { data, error } = await window.supabaseClient
      .from("study_sets")
      .select("*")
      .eq("user_id", currentUser.id)
      .order("updated_at", { ascending:false });

    $("btnRefresh").disabled = false;

    if(error){
      console.error(error);
      setLoadingList(false);
      $("setsList").innerHTML = "";
      $("emptyHint").style.display = "block";
      return;
    }

    allSets = data || [];
    renderSets();
  }

  function renderSets(){
    const q = $("search").value.trim().toLowerCase();
    const list = $("setsList");
    list.innerHTML = "";

    const filtered = q
      ? allSets.filter(s =>
          (s.name || "").toLowerCase().includes(q) ||
          (s.subject || "").toLowerCase().includes(q)
        )
      : allSets;

    $("emptyHint").style.display = filtered.length ? "none" : "block";

    for(const set of filtered){
      const card = document.createElement("div");
      card.className = "set-card";

      const name = escapeHtml(set.name || "Untitled set");
      const subject = escapeHtml(set.subject || "General");
      const desc = (set.description || "").trim();

      card.innerHTML = `
        <div class="set-top">
          <div>
            <div class="set-name">${name}</div>
            ${desc ? `<div class="desc">${escapeHtml(desc)}</div>` : ``}
          </div>
          <span class="badge">${subject}</span>
        </div>

        <div class="actions">
          <button class="btn primary small" data-fc="${set.id}">üÉè Revise as flashcards</button>
          <button class="btn small" data-edit="${set.id}">Edit</button>
          <button class="btn danger small" data-del="${set.id}">Delete</button>
        </div>
      `;

      // ‚úÖ This was missing in your version
      card.querySelector("[data-fc]").onclick = () => {
        window.location.href = `flashcards.html?set=${encodeURIComponent(set.id)}`;
      };

      card.querySelector("[data-edit]").onclick = () => {
        window.location.href = `editset.html?id=${encodeURIComponent(set.id)}`;
      };

      card.querySelector("[data-del]").onclick = () => {
        deleteSet(set.id);
      };

      list.appendChild(card);
    }
  }

  async function createSet(){
    clearMsg();

    const name = $("setName").value.trim();
    const subject = $("setSubject").value.trim();
    const desc = $("setDesc").value.trim();

    if(!name){
      showMsg("Enter a set name.", true);
      $("setName").focus();
      return;
    }

    $("btnCreate").disabled = true;

    const { error } = await window.supabaseClient
      .from("study_sets")
      .insert({
        user_id: currentUser.id,
        name,
        subject: subject || "General",
        description: desc || ""
      });

    $("btnCreate").disabled = false;

    if(error){
      console.error(error);
      showMsg("Error creating set. Check console.", true);
      return;
    }

    showMsg("Set created ‚úÖ");
    clearForm();
    await loadSets();
  }

  async function deleteSet(id){
    if(!confirm("Delete this set? This cannot be undone.")) return;

    const { error } = await window.supabaseClient
      .from("study_sets")
      .delete()
      .eq("id", id)
      .eq("user_id", currentUser.id);

    if(error){
      console.error(error);
      alert("Delete failed.");
      return;
    }

    await loadSets();
  }

  init();
</script>
</body>
</html>