<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GCSE Focus â€” Sign In</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b1020;
  --panel:rgba(255,255,255,.06);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.6);
  --border:rgba(255,255,255,.15);
  --brand:#8ea2ff;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:
    radial-gradient(1200px 700px at 10% 10%, rgba(142,162,255,.25),transparent 60%),
    radial-gradient(900px 600px at 90% 20%, rgba(70,230,179,.15),transparent 55%),
    var(--bg);
  color:var(--text);
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.auth-box{
  width:420px;
  padding:40px;
  background:var(--panel);
  backdrop-filter:blur(20px);
  border:1px solid var(--border);
  border-radius:20px;
}

h1{
  margin:0 0 8px 0;
  font-size:28px;
  text-align:center;
}

.subtitle{
  text-align:center;
  color:var(--muted);
  margin-bottom:25px;
  font-size:14px;
}

input{
  width:100%;
  padding:12px;
  margin-top:12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
}

button{
  width:100%;
  padding:12px;
  margin-top:16px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#8ea2ff,#46e6b3);
  font-weight:bold;
  cursor:pointer;
}

.link{
  margin-top:14px;
  text-align:center;
  font-size:14px;
  color:var(--muted);
  cursor:pointer;
}

.link:hover{
  color:white;
}

.hidden{display:none;}

.message{
  margin-top:12px;
  font-size:14px;
  text-align:center;
  color:#ff7b8f;
}

.success{
  color:#46e6b3;
}

footer{
  position:absolute;
  bottom:20px;
  width:100%;
  text-align:center;
  font-size:13px;
}
footer a{
  color:white;
  text-decoration:none;
  margin:0 6px;
}
</style>
</head>

<body>

<div class="auth-box">

<h1>GCSE Focus</h1>
<div class="subtitle">Study smarter. Focus better.</div>

<div id="signin">
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="signIn()">Sign In</button>
  <div class="link" onclick="showSignup()">Create account</div>
  <div class="link" onclick="showReset()">Forgot password?</div>
  <div id="signinMsg" class="message"></div>
</div>

<div id="signup" class="hidden">
  <input id="signupUsername" type="text" placeholder="Choose username">
  <input id="signupEmail" type="email" placeholder="Email">
  <input id="signupPassword" type="password" placeholder="Password">
  <button onclick="signUp()">Create Account</button>
  <div class="link" onclick="showSignin()">Back to sign in</div>
  <div id="signupMsg" class="message"></div>
</div>

<div id="reset" class="hidden">
  <input id="resetEmail" type="email" placeholder="Email">
  <button onclick="resetPassword()">Send Reset Link</button>
  <div class="link" onclick="showSignin()">Back to sign in</div>
  <div id="resetMsg" class="message"></div>
</div>

</div>

<footer>
  <a href="privacy.html">Privacy Policy</a> |
  <a href="terms.html">Terms of Service</a>
</footer>

<script>
const SUPABASE_URL = "https://mgpwknnbhaljsscsvucm.supabase.co";
const SUPABASE_KEY = "sb_publishable_6tdnozSH6Ck75uDgXPN-sg_Mn7vyLFs";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

document.addEventListener("DOMContentLoaded", async () => {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (session) window.location.href = "start.html";
});

function showSignup(){
  signin.classList.add("hidden");
  reset.classList.add("hidden");
  signup.classList.remove("hidden");
}

function showSignin(){
  signup.classList.add("hidden");
  reset.classList.add("hidden");
  signin.classList.remove("hidden");
}

function showReset(){
  signin.classList.add("hidden");
  signup.classList.add("hidden");
  reset.classList.remove("hidden");
}

async function signIn(){
  signinMsg.textContent = "";

  const { error } = await supabaseClient.auth.signInWithPassword({
    email: email.value.trim(),
    password: password.value
  });

  if(error){
    signinMsg.textContent = error.message;
  } else {
    window.location.href = "start.html";
  }
}

async function signUp(){
  signupMsg.textContent = "";

  const username = signupUsername.value.trim();
  const emailVal = signupEmail.value.trim();
  const passwordVal = signupPassword.value;

  if(!username){
    signupMsg.textContent = "Please choose a username.";
    return;
  }

  // Check username uniqueness
  const { data: existing } = await supabaseClient
    .from("user_settings")
    .select("id")
    .eq("username", username)
    .maybeSingle();

  if(existing){
    signupMsg.textContent = "Username already taken.";
    return;
  }

  const { data, error } = await supabaseClient.auth.signUp({
    email: emailVal,
    password: passwordVal
  });

  if(error){
    signupMsg.textContent = error.message;
    return;
  }

  if(data.user){
    await supabaseClient.from("user_settings").insert({
      user_id: data.user.id,
      username: username,
      tier: "free",
      role: "user",
      preferred_theme: "auto",
      reminder_time: "08:00",
      notify_updates: true,
      notify_promos: false
    });
  }

  signupMsg.classList.add("success");
  signupMsg.textContent = "Account created. You can now sign in.";
}

async function resetPassword(){
  resetMsg.textContent = "";

  const { error } = await supabaseClient.auth.resetPasswordForEmail(
    resetEmail.value.trim(),
    {
      redirectTo: window.location.origin + "/auth.html"
    }
  );

  if(error){
    resetMsg.textContent = error.message;
  } else {
    resetMsg.classList.add("success");
    resetMsg.textContent = "Reset email sent.";
  }
}
</script>

</body>
</html>