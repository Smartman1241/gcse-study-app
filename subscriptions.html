<!doctype html>
<html lang="en" data-theme="dark">
<head>
<script src="theme.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReviseFlow — Upgrade</title>
  <meta name="description" content="Upgrade to Plus or Pro to unlock more study power." />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#070a14;
      --bg1:#0b1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.12);
      --stroke2:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.55);
      --good:#5dffb1;
      --bad:#ff6b6b;
      --accent:#7c5cff;
      --accent2:#4ad7ff;
      --warn:#ffd166;
      --shadow: 0 16px 50px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:24px;
      --pad:16px;
      --pad2:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(74,215,255,.12), transparent 60%),
        radial-gradient(900px 600px at 50% 90%, rgba(255,209,102,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    a{ color:inherit; text-decoration:none; }

    .wrap{
      width:min(1200px, 92vw);
      margin:0 auto;
      padding:28px 0 60px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:14px;
      padding:10px 0 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
      font-size:16px;
    }

    .logo{
      width:34px;
      height:34px;
      border-radius:10px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(124,92,255,1), rgba(74,215,255,1));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
    }

    .topActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border:1px solid var(--stroke2);
      background:rgba(255,255,255,.04);
      border-radius:999px;
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }

    .pill strong{
      color:var(--text);
      font-weight:800;
    }

    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }

    .btn:hover{
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.16);
    }

    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      border-color:rgba(124,92,255,.5);
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(74,215,255,.85));
      box-shadow: 0 18px 60px rgba(124,92,255,.25);
    }

    .btn.primary:hover{ filter:brightness(1.03); }

    .btn.ghost{ background:transparent; }

    .btn.small{
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
    }

    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .hero{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:16px;
      align-items:stretch;
      margin-top:4px;
    }

    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
    }

    .heroCard{
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius2);
      padding: 22px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .heroCard:before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(800px 350px at 10% 0%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(800px 350px at 90% 30%, rgba(74,215,255,.16), transparent 60%);
      pointer-events:none;
    }

    .heroInner{ position:relative; z-index:1; }

    .hero h1{
      margin:0 0 10px;
      font-size: clamp(26px, 3.1vw, 42px);
      line-height:1.1;
      letter-spacing:-.4px;
    }

    .sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:15px;
      max-width: 72ch;
    }

    .callouts{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--stroke2);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      font-size:13px;
      color:var(--muted);
    }

    .dot{
      width:9px;
      height:9px;
      border-radius:999px;
      background:var(--good);
      box-shadow: 0 0 0 4px rgba(93,255,177,.12);
    }

    .heroSide{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius2);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .cycleBox{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .cycleTitle{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .cycleTitle h3{
      margin:0;
      font-size:15px;
      letter-spacing:.1px;
    }

    .cycleTitle p{
      margin:4px 0 0;
      font-size:13px;
      color:var(--muted);
    }

    .seg{
      display:flex;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:4px;
      gap:4px;
    }

    .seg button{
      flex:1;
      border:0;
      background:transparent;
      color:var(--muted);
      padding:10px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition: background .12s ease, color .12s ease;
      text-align:center;
      line-height:1.1;
    }

    .seg button.active{
      background: rgba(255,255,255,.08);
      color:var(--text);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    .seg button .mini{
      display:block;
      font-size:11px;
      color:var(--muted2);
      font-weight:800;
      margin-top:3px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr .62fr;
      gap:16px;
      margin-top:16px;
      align-items:start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .plans{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .plansHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    .plansHeader h2{ margin:0; font-size:16px; }

    .plansHeader .hint{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    .planRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    @media (max-width: 740px){
      .planRow{ grid-template-columns: 1fr; }
    }

    .planCard{
      position:relative;
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius2);
      padding: 18px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      min-height: 260px;
    }

    .planCard:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
    }

    .planCard.selected{
      border-color: rgba(124,92,255,.5);
      box-shadow: 0 20px 70px rgba(124,92,255,.16);
    }

    .planTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .planName{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .planName h3{
      margin:0;
      font-size:18px;
      letter-spacing:.1px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .planBadge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(124,92,255,.30);
      background: rgba(124,92,255,.10);
      color: rgba(255,255,255,.88);
      font-size:11px;
      font-weight:950;
      letter-spacing:.4px;
      white-space:nowrap;
    }

    .planBadge i{
      width:7px;
      height:7px;
      border-radius:999px;
      background: rgba(74,215,255,.95);
      box-shadow: 0 0 0 4px rgba(74,215,255,.12);
      display:inline-block;
    }

    .planName .desc{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }

    .priceBox{
      text-align:right;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }

    .price{
      font-size:26px;
      font-weight:950;
      letter-spacing:-.4px;
      margin:0;
      line-height:1;
    }

    .per{
      margin:0;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    .save{
      margin:0;
      color:var(--warn);
      font-size:12px;
      font-weight:950;
    }

    .miniList{
      margin:14px 0 0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      color:var(--muted);
      font-size:13px;
    }

    .miniList li{
      display:flex;
      gap:10px;
      align-items:flex-start;
      line-height:1.25;
    }

    .tick{
      width:18px;
      height:18px;
      border-radius:8px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(93,255,177,.12);
      border:1px solid rgba(93,255,177,.22);
      flex:0 0 18px;
      margin-top:1px;
    }

    .tick:before{
      content:"✓";
      color:var(--good);
      font-weight:1000;
      font-size:12px;
      position:relative;
      top:-.5px;
    }

    .basket{
      position:sticky;
      top:16px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius2);
      padding: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .basketHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }

    .basketHeader h2{
      margin:0;
      font-size:15px;
    }

    .badge{
      font-size:11px;
      font-weight:950;
      color:#0b1020;
      padding:6px 10px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(255,209,102,.92), rgba(74,215,255,.80));
    }

    .basketLine{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 0;
      border-top:1px solid rgba(255,255,255,.07);
      font-size:13px;
      color:var(--muted);
    }

    .basketLine:first-of-type{ border-top:0; }

    .basketLine strong{ color:var(--text); }

    .basketTotal{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px 0 6px;
      border-top:1px solid rgba(255,255,255,.10);
      font-size:14px;
    }

    .basketTotal .big{
      font-size:20px;
      font-weight:1000;
      letter-spacing:-.3px;
    }

    .basketHelp{
      margin:8px 0 0;
      font-size:12px;
      color:var(--muted2);
      line-height:1.35;
    }

    .basketBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }

    .basketBtns .btn{
      flex:1;
      min-width:140px;
    }

    .err{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,107,107,.25);
      background: rgba(255,107,107,.10);
      color: rgba(255,255,255,.88);
      font-size:13px;
      display:none;
      line-height:1.35;
    }

    .ok{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(93,255,177,.24);
      background: rgba(93,255,177,.08);
      color: rgba(255,255,255,.88);
      font-size:13px;
      display:none;
      line-height:1.35;
    }

    .consentBox{
      margin-top:12px;
      border-top:1px solid rgba(255,255,255,.10);
      padding-top:12px;
    }

    .checkRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }

    .checkRow input{
      width:18px;
      height:18px;
      margin-top:2px;
      accent-color: var(--accent);
      cursor:pointer;
      flex:0 0 auto;
    }

    .checkRow label{
      cursor:pointer;
      color: rgba(255,255,255,.86);
      font-size:12.8px;
      line-height:1.35;
      font-weight:800;
    }

    .checkRow label span{
      display:block;
      margin-top:4px;
      color: var(--muted2);
      font-weight:800;
      font-size:12px;
    }

    .section{
      margin-top:16px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .section h2{
      margin:0 0 10px;
      font-size:16px;
      letter-spacing:.1px;
    }

    .section .lead{
      margin:0 0 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin: 10px 0 14px;
    }

    .input{
      flex:1;
      min-width:240px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-weight:700;
      outline:none;
    }

    .select{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-weight:800;
      outline:none;
      min-width:180px;
    }

    .tableWrap{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(0,0,0,.16);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }

    thead th{
      position:sticky;
      top:0;
      background: rgba(10,14,28,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:12px 12px;
      text-align:left;
      z-index:2;
    }

    thead th:nth-child(2),
    thead th:nth-child(3){
      text-align:center;
      width:160px;
    }

    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:10px 12px;
      vertical-align:top;
      color:var(--muted);
    }

    tbody td:first-child{
      color:var(--text);
      font-weight:900;
    }

    tbody td:nth-child(2),
    tbody td:nth-child(3){
      text-align:center;
      color:var(--muted);
      font-weight:900;
    }

    .groupRow td{
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight:1000;
      letter-spacing:.2px;
    }

    .yes{ color: var(--good) !important; }
    .no{ color: rgba(255,255,255,.25) !important; }

    .tiny{
      display:block;
      font-size:11px;
      color:var(--muted2);
      font-weight:800;
      margin-top:3px;
      line-height:1.25;
    }

    .cellWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:3px;
      padding:2px 0;
    }

    .cellWrap .mark{
      font-weight:1000;
      font-size:14px;
      line-height:1;
    }

    .faq{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    @media (max-width: 980px){
      .faq{ grid-template-columns: 1fr; }
    }

    details{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      padding: 12px 12px;
    }

    summary{
      cursor:pointer;
      font-weight:950;
      color:var(--text);
      outline:none;
    }

    details p{
      margin:10px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }

    .fineprint{
      margin-top:14px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.45;
    }

    .toast{
      position:fixed;
      bottom:14px;
      left:50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius: 999px;
      color: rgba(255,255,255,.9);
      font-weight:800;
      font-size:13px;
      box-shadow: 0 18px 60px rgba(0,0,0,.6);
      display:none;
      z-index:999;
      max-width:min(780px, 92vw);
      text-align:center;
    }

    .srOnly{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>ReviseFlow <span style="opacity:.7">/ Upgrade</span></div>
      </div>

      <div class="topActions">
        <div class="pill"><span class="dot" aria-hidden="true"></span><strong>Annual</strong> shows best value</div>
        <button class="btn ghost" id="backBtn" type="button">← Back</button>
        <button class="btn" id="refreshBtn" type="button">Reset</button>
      </div>
    </div>

    <div class="hero">
      <div class="heroCard">
        <div class="heroInner">
          <h1>Upgrade your study setup — faster, smarter, calmer.</h1>
          <p class="sub">
            Pick a plan, choose your billing cycle, and checkout via Stripe.
            The comparison below lists what each plan includes.
          </p>

          <div class="callouts">
            <div class="tag"><span class="dot"></span> Cancel anytime</div>
            <div class="tag"><span class="dot"></span> Secure checkout (Stripe)</div>
            <div class="tag"><span class="dot"></span> Annual = biggest discount</div>
            <div class="tag"><span class="dot"></span> Instant access after payment</div>
          </div>
        </div>
      </div>

      <div class="heroSide">
        <div class="cycleBox">
          <div class="cycleTitle">
            <div>
              <h3>Billing cycle</h3>
              <p>Annual is highlighted because it saves the most.</p>
            </div>
          </div>

          <div class="seg" role="tablist" aria-label="Billing cycle">
            <button id="cycleMonthly" type="button" data-cycle="monthly">Monthly<span class="mini">Try it</span></button>
            <button id="cycleQuarterly" type="button" data-cycle="quarterly">Quarterly<span class="mini">Save a bit</span></button>
            <button id="cycleAnnual" type="button" data-cycle="annual">Annual<span class="mini">Best value</span></button>
          </div>

          <div class="fineprint" id="cycleExplain"></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="plans">
        <div class="plansHeader">
          <div>
            <h2>Choose your plan</h2>
            <p class="hint">Click a card to add it to your basket.</p>
          </div>

          <div class="pill"><strong id="pickedSummary">Annual · Pro</strong></div>
        </div>

        <div class="planRow">
          <div class="planCard" id="cardPlus" role="button" tabindex="0" aria-label="Select Plus">
            <div class="planTop">
              <div class="planName">
                <h3>Plus</h3>
                <p class="desc">Better study tools + more AI help.</p>
              </div>

              <div class="priceBox">
                <p class="price" id="plusPrice">£—</p>
                <p class="per" id="plusPer">per —</p>
                <p class="save" id="plusSave"> </p>
              </div>
            </div>

            <ul class="miniList" id="plusMini">
              <li><span class="tick"></span><span>Step-by-step GCSE explanations + rewrite mode</span></li>
              <li><span class="tick"></span><span>Flashcards with spaced repetition</span></li>
              <li><span class="tick"></span><span>Quiz generator + instant marking</span></li>
              <li><span class="tick"></span><span>Study analytics + streak tracking</span></li>
              <li><span class="tick"></span><span>Upload analysis: <strong>1 image/PDF per day</strong></span></li>
            </ul>
          </div>

          <div class="planCard selected" id="cardPro" role="button" tabindex="0" aria-label="Select Pro">
            <div class="planTop">
              <div class="planName">
                <h3>Pro <span class="planBadge"><i aria-hidden="true"></i>More power</span></h3>
                <p class="desc">Everything in Plus, and the “serious” tools.</p>
              </div>

              <div class="priceBox">
                <p class="price" id="proPrice">£—</p>
                <p class="per" id="proPer">per —</p>
                <p class="save" id="proSave"> </p>
              </div>
            </div>

            <ul class="miniList" id="proMini">
              <li><span class="tick"></span><span>Higher AI limits + advanced modes</span></li>
              <li><span class="tick"></span><span>Examiner-style feedback + weak-topic map</span></li>
              <li><span class="tick"></span><span>Premium packs + model answers</span></li>
              <li><span class="tick"></span><span>Priority support + early features</span></li>
              <li><span class="tick"></span><span>Upload analysis: <strong>up to 4 images/PDFs per day</strong></span></li>
            </ul>
          </div>
        </div>

        <div class="section" style="margin-top:14px;">
          <h2>Compare everything</h2>
          <p class="lead">
            Search features or filter by category. “Pro” includes everything in “Plus”.
          </p>

          <div class="tools">
            <input class="input" id="search" placeholder="Search features… (e.g. uploads, flashcards, marking, analytics)" />
            <select class="select" id="groupFilter">
              <option value="all">All categories</option>
            </select>
            <button class="btn small" id="clearSearchBtn" type="button">Clear</button>
          </div>

          <div class="tableWrap" style="max-height:520px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Feature</th>
                  <th>Plus</th>
                  <th>Pro</th>
                </tr>
              </thead>
              <tbody id="featureBody"></tbody>
            </table>
          </div>

          <div class="fineprint">
            Pricing and savings are shown transparently. Annual is highlighted because it’s the lowest effective monthly cost.
          </div>
        </div>

        <div class="section">
          <h2>FAQ</h2>
          <p class="lead">Quick answers to common billing questions.</p>

          <div class="faq">
            <details>
              <summary>Can I cancel anytime?</summary>
              <p>Yes. You can cancel your subscription in Stripe’s customer portal (recommended) or by contacting support.</p>
            </details>

            <details>
              <summary>Do I get access immediately?</summary>
              <p>Yes. After payment, your subscription is confirmed by webhook and your plan is unlocked automatically.</p>
            </details>

            <details>
              <summary>What are the upload limits?</summary>
              <p>Plus: up to 1 image/PDF per day. Pro: up to 4 images/PDFs per day. Limits reset daily.</p>
            </details>

            <details>
              <summary>How does the app know what plan I bought?</summary>
              <p>Stripe webhooks update your plan in Supabase. The app reads your plan server-side, not from the success redirect.</p>
            </details>
          </div>

          <div class="fineprint">
            Tip: Add a “Manage billing” button later via Stripe Billing Portal.
          </div>
        </div>
      </div>

      <aside class="basket" aria-label="Basket">
        <div class="basketHeader">
          <h2>Your basket</h2>
          <div class="badge" id="valueBadge">Best value</div>
        </div>

        <div class="basketLine">
          <div>Plan</div>
          <div><strong id="bPlan">Pro</strong></div>
        </div>

        <div class="basketLine">
          <div>Billing</div>
          <div><strong id="bCycle">Annual</strong></div>
        </div>

        <div class="basketLine">
          <div>Price</div>
          <div><strong id="bPrice">£—</strong></div>
        </div>

        <div class="basketLine">
          <div>Savings</div>
          <div><strong id="bSave">—</strong></div>
        </div>

        <div class="basketTotal">
          <div>
            <div style="font-weight:950;">Total today</div>
            <span class="tiny" id="bRenew">Renews in —</span>
          </div>

          <div class="big" id="bTotal">£—</div>
        </div>

        <div class="basketHelp" id="basketHelp">
          Annual is selected by default because it’s the lowest cost per month.
        </div>

        <div class="consentBox" aria-label="Purchase consent">
          <div class="checkRow">
            <input type="checkbox" id="consentNow" />
            <label for="consentNow">
              I request immediate access after payment and I understand I lose my 14-day cooling-off right.
              <span>
                This is a digital service. Access starts immediately after checkout. By continuing, you expressly waive your statutory cancellation period.
              </span>
            </label>
          </div>
          <div class="fineprint" style="margin-top:10px;">
            You’ll be redirected to Stripe Checkout. The selected plan will appear in the Stripe order summary.
          </div>
        </div>

        <div class="basketBtns">
          <button class="btn primary" id="checkoutBtn" disabled type="button">Checkout</button>
          <button class="btn" id="copyBtn" type="button">Copy summary</button>
        </div>

        <div class="err" id="errBox"></div>
        <div class="ok" id="okBox"></div>

        <div class="fineprint" style="margin-top:12px;">
          If checkout doesn’t open, disable ad-blockers for this site and try again.
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const PRICE_IDS = {
      plus: {
        monthly:   "price_1T46nyRzC23qaxzMIu41ccnt",
        quarterly: "price_1T46nyRzC23qaxzM2apXOsNE",
        annual:    "price_1T46nyRzC23qaxzMsuQppAj6"
      },
      pro: {
        monthly:   "price_1T46qbRzC23qaxzM2ebMn3o6",
        quarterly: "price_1T46qbRzC23qaxzMh15YdWfh",
        annual:    "price_1T46qbRzC23qaxzMC9TWNVsK"
      }
    };

    const DISPLAY_PRICES = {
      plus: { monthly: 4.99, quarterly: 12.99, annual: 37.99 },
      pro:  { monthly: 9.99, quarterly: 24.99, annual: 79.99 }
    };

    const CYCLE_LABEL  = { monthly:"Monthly", quarterly:"Quarterly", annual:"Annual" };
    const CYCLE_MONTHS = { monthly:1, quarterly:3, annual:12 };

    // =========================
    // SUPABASE AUTH (USER ID)
    // =========================
    // IMPORTANT: Use your real Supabase anon key (NOT Stripe keys).
    // If you already set these globally, it will reuse them.
    const SUPABASE_URL = window.SUPABASE_URL || "https://mgpwknnbhaljsscsvucm.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_6tdnozSH6Ck75uDgXPN-sg_Mn7vyLFs";

    const supabaseClient = (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    let currentUserId = null;

    async function loadUser(){
      if(!supabaseClient) return null;
      const { data, error } = await supabaseClient.auth.getSession();
      if(error) return null;
      const user = data?.session?.user || null;
      currentUserId = user?.id || null;
      return currentUserId;
    }

    // =========================
    // STATE
    // =========================
    let selectedPlan = "pro";
    let selectedCycle = "annual";

    const $ = (id) => document.getElementById(id);

    const els = {
      cycleMonthly: $("cycleMonthly"),
      cycleQuarterly: $("cycleQuarterly"),
      cycleAnnual: $("cycleAnnual"),
      cycleExplain: $("cycleExplain"),

      cardPlus: $("cardPlus"),
      cardPro: $("cardPro"),

      plusPrice: $("plusPrice"),
      plusPer: $("plusPer"),
      plusSave: $("plusSave"),

      proPrice: $("proPrice"),
      proPer: $("proPer"),
      proSave: $("proSave"),

      pickedSummary: $("pickedSummary"),

      bPlan: $("bPlan"),
      bCycle: $("bCycle"),
      bPrice: $("bPrice"),
      bSave: $("bSave"),
      bTotal: $("bTotal"),
      bRenew: $("bRenew"),
      basketHelp: $("basketHelp"),
      valueBadge: $("valueBadge"),

      checkoutBtn: $("checkoutBtn"),
      copyBtn: $("copyBtn"),
      errBox: $("errBox"),
      okBox: $("okBox"),
      toast: $("toast"),

      consentNow: $("consentNow"),

      search: $("search"),
      groupFilter: $("groupFilter"),
      featureBody: $("featureBody"),
      clearSearchBtn: $("clearSearchBtn"),

      backBtn: $("backBtn"),
      refreshBtn: $("refreshBtn")
    };

    // =========================
    // UI HELPERS
    // =========================
    function money(n){ return "£" + Number(n).toFixed(2); }

    function showErr(msg){
      els.okBox.style.display = "none";
      els.okBox.textContent = "";
      els.errBox.style.display = "block";
      els.errBox.textContent = msg;
    }

    function showOk(msg){
      els.errBox.style.display = "none";
      els.errBox.textContent = "";
      els.okBox.style.display = "block";
      els.okBox.textContent = msg;
    }

    function clearMsgs(){
      els.errBox.style.display = "none";
      els.errBox.textContent = "";
      els.okBox.style.display = "none";
      els.okBox.textContent = "";
    }

    function toast(msg){
      els.toast.textContent = msg;
      els.toast.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ els.toast.style.display="none"; }, 1500);
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // PRICING HELPERS
    // =========================
    function calcSavings(plan, cycle){
      const m = DISPLAY_PRICES[plan].monthly;
      const q = DISPLAY_PRICES[plan].quarterly;
      const a = DISPLAY_PRICES[plan].annual;

      const yearlyMonthly = m * 12;
      const yearlyQuarterly = q * 4;

      if(cycle === "annual"){
        const saveVsMonthly = yearlyMonthly - a;
        const saveVsQuarterly = yearlyQuarterly - a;
        const pct = (saveVsMonthly / yearlyMonthly) * 100;
        return { label: `${money(saveVsMonthly)} saved vs monthly`, extra: `${money(saveVsQuarterly)} saved vs quarterly`, pct };
      }

      if(cycle === "quarterly"){
        const saveVsMonthly = yearlyMonthly - yearlyQuarterly;
        const pct = (saveVsMonthly / yearlyMonthly) * 100;
        return { label: `${money(saveVsMonthly)} saved vs monthly (per year)`, extra: `Annual saves more`, pct };
      }

      return { label: `Annual saves the most`, extra: `Upgrade to annual anytime`, pct: 0 };
    }

    function cycleExplainText(){
      if(selectedCycle === "annual"){
        return `
          <strong>Annual is best value:</strong><br>
          Plus saves <strong>${money((DISPLAY_PRICES.plus.monthly*12) - DISPLAY_PRICES.plus.annual)}</strong> per year vs monthly.<br>
          Pro saves <strong>${money((DISPLAY_PRICES.pro.monthly*12) - DISPLAY_PRICES.pro.annual)}</strong> per year vs monthly.
        `;
      }
      if(selectedCycle === "quarterly"){
        return `Quarterly is a mid option.<br>You still save vs monthly, but annual is the biggest discount.`;
      }
      return `Monthly is best for trying it out.<br>If you already know you’ll use it, annual is cheaper overall.`;
    }

    // =========================
    // RENDERING
    // =========================
    function renderCards(){
      const c = selectedCycle;

      const plusP = DISPLAY_PRICES.plus[c];
      const proP  = DISPLAY_PRICES.pro[c];

      const plusEff = plusP / CYCLE_MONTHS[c];
      const proEff  = proP / CYCLE_MONTHS[c];

      const plusS = calcSavings("plus", c);
      const proS  = calcSavings("pro", c);

      els.plusPrice.textContent = money(plusP);
      els.plusPer.textContent = c === "monthly" ? "per month" : (c==="quarterly" ? "per 3 months" : "per year");
      els.plusSave.textContent = (c === "monthly") ? "Annual saves most" : `Save ~${plusS.pct.toFixed(0)}%`;
      els.plusSave.textContent += ` · Effective ~${money(plusEff)}/mo`;

      els.proPrice.textContent = money(proP);
      els.proPer.textContent = c === "monthly" ? "per month" : (c==="quarterly" ? "per 3 months" : "per year");
      els.proSave.textContent = (c === "monthly") ? "Annual saves most" : `Save ~${proS.pct.toFixed(0)}%`;
      els.proSave.textContent += ` · Effective ~${money(proEff)}/mo`;

      if(c === "annual") els.valueBadge.textContent = "Best value";
      else if(c === "quarterly") els.valueBadge.textContent = "Balanced";
      else els.valueBadge.textContent = "Try it";
    }

    function renderBasket(){
      const plan = selectedPlan;
      const cycle = selectedCycle;
      const price = DISPLAY_PRICES[plan][cycle];

      els.bPlan.textContent = plan === "pro" ? "Pro" : "Plus";
      els.bCycle.textContent = CYCLE_LABEL[cycle];
      els.bPrice.textContent = money(price);
      els.bTotal.textContent = money(price);

      const s = calcSavings(plan, cycle);
      els.bSave.textContent = (cycle === "annual") ? s.label : (cycle === "quarterly" ? s.label : "Annual saves most");
      els.bRenew.textContent = cycle === "annual" ? "Renews yearly" : (cycle==="quarterly" ? "Renews every 3 months" : "Renews monthly");

      if(cycle === "annual"){
        els.basketHelp.innerHTML = `You chose <strong>annual</strong>. That’s the lowest effective monthly cost.`;
      } else if(cycle === "quarterly"){
        els.basketHelp.innerHTML = `Quarterly is a good middle ground. Annual still costs less overall.`;
      } else {
        els.basketHelp.innerHTML = `Monthly is flexible. If you’ll use it long-term, annual saves the most.`;
      }
    }

    // =========================
    // FEATURES TABLE
    // =========================
    const FEATURES = [
      { g:"Included in Plus & Pro", f:"Step-by-step GCSE explanations (AI tutor)", plus:1, pro:1 },
      { g:"Included in Plus & Pro", f:"Answer rewriter (shorter / clearer)", plus:1, pro:1 },
      { g:"Included in Plus & Pro", f:"Flashcards with spaced repetition", plus:1, pro:1 },
      { g:"Included in Plus & Pro", f:"Quiz generator + instant marking", plus:1, pro:1 },
      { g:"Included in Plus & Pro", f:"Past-paper tracking + practice sessions", plus:1, pro:1 },
      { g:"Included in Plus & Pro", f:"Study planner + tasks", plus:1, pro:1 },
      { g:"Included in Plus & Pro", f:"Progress analytics + streak tracking", plus:1, pro:1 },

      { g:"Upload limits", f:"Upload work for analysis (Images + PDFs)", plus:1, pro:1, plusNote:"1 per day", proNote:"Up to 4 per day" },

      { g:"Pro upgrades", f:"Higher AI limits", plus:0, pro:1 },
      { g:"Pro upgrades", f:"Examiner-style feedback (marks / AO)", plus:0, pro:1 },
      { g:"Pro upgrades", f:"Weak-topic heatmap", plus:0, pro:1 },
      { g:"Pro upgrades", f:"Grade projection", plus:0, pro:1 },
      { g:"Pro upgrades", f:"Priority AI at peak times", plus:0, pro:1 },
      { g:"Pro upgrades", f:"Premium packs + model answers", plus:0, pro:1 },
      { g:"Pro upgrades", f:"Priority support + early features", plus:0, pro:1 }
    ];

    function buildGroupFilter(){
      const groups = Array.from(new Set(FEATURES.map(x=>x.g)));
      groups.sort((a,b)=>a.localeCompare(b));
      for(const g of groups){
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        els.groupFilter.appendChild(opt);
      }
    }

    function cellHtml(ok, note){
      if(!ok) return `<div class="cellWrap"><span class="mark no">—</span></div>`;
      const n = note ? `<span class="tiny">${escapeHtml(note)}</span>` : "";
      return `<div class="cellWrap"><span class="mark yes">✓</span>${n}</div>`;
    }

    function renderFeatures(){
      const q = (els.search.value || "").trim().toLowerCase();
      const gf = els.groupFilter.value;

      let rows = FEATURES;
      if(gf !== "all") rows = rows.filter(x => x.g === gf);
      if(q) rows = rows.filter(x => (x.f || "").toLowerCase().includes(q));

      let html = "";
      let lastGroup = null;

      for(const r of rows){
        if(r.g !== lastGroup){
          html += `<tr class="groupRow"><td colspan="3">${escapeHtml(r.g)}</td></tr>`;
          lastGroup = r.g;
        }
        html += `
          <tr>
            <td>${escapeHtml(r.f)}</td>
            <td>${cellHtml(!!r.plus, r.plusNote || "")}</td>
            <td>${cellHtml(!!r.pro, r.proNote || "")}</td>
          </tr>
        `;
      }

      els.featureBody.innerHTML = html || `<tr><td colspan="3" style="padding:16px;color:rgba(255,255,255,.6)">No matches.</td></tr>`;
    }

    // =========================
    // CLIENT ANTI-SPAM
    // =========================
    function makeClientNonce(){
      try{
        const k = "rf_client_nonce_v1";
        let v = localStorage.getItem(k);
        if(!v || v.length < 16){
          v = (crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + String(Date.now()));
          localStorage.setItem(k, v);
        }
        return v;
      }catch{
        return String(Math.random()).slice(2) + String(Date.now());
      }
    }

    function getAttemptBucketKey(){
      const now = new Date();
      const key = `${now.getUTCFullYear()}-${String(now.getUTCMonth()+1).padStart(2,"0")}-${String(now.getUTCDate()).padStart(2,"0")}-${String(now.getUTCHours()).padStart(2,"0")}`;
      return "rf_checkout_attempts_" + key;
    }

    function bumpAttempts(){
      try{
        const key = getAttemptBucketKey();
        const cur = Number(localStorage.getItem(key) || "0");
        const next = cur + 1;
        localStorage.setItem(key, String(next));
        return next;
      }catch{
        return 1;
      }
    }

    function getAttempts(){
      try{
        const key = getAttemptBucketKey();
        return Number(localStorage.getItem(key) || "0");
      }catch{
        return 0;
      }
    }

    function canAttemptCheckout(){
      return getAttempts() < 8;
    }

    // =========================
    // CHECKOUT ENABLEMENT
    // =========================
    let checkoutLock = false;
    let lastCheckoutAt = 0;

    function updateCheckoutEnabled(){
      const consentOk = !!els.consentNow.checked;
      const signedInOk = !!currentUserId;
      els.checkoutBtn.disabled = !consentOk || !signedInOk || checkoutLock;
    }

    async function safeJson(res){
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if(ct.includes("application/json")) return await res.json();
      const txt = await res.text();
      return { raw: txt };
    }

    async function postWithTimeout(url, body, ms){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), ms);
      try{
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(body),
          signal: controller.signal
        });
        const data = await safeJson(res);
        return { res, data };
      } finally {
        clearTimeout(t);
      }
    }

    // =========================
    // STRIPE CHECKOUT
    // =========================
    async function startCheckout(){
      clearMsgs();

      if(!currentUserId){
        showErr("Please sign in before checking out.");
        return;
      }

      if(navigator.webdriver){
        showErr("Checkout is unavailable in automated browsers.");
        return;
      }

      if(!els.consentNow.checked){
        showErr("Tick the checkbox to continue.");
        return;
      }

      const now = Date.now();
      if(now - lastCheckoutAt < 3500){
        showErr("Please wait a moment and try again.");
        return;
      }

      if(!canAttemptCheckout()){
        showErr("Too many attempts. Please wait a bit and try again.");
        return;
      }

      lastCheckoutAt = now;
      bumpAttempts();

      checkoutLock = true;
      updateCheckoutEnabled();
      els.checkoutBtn.textContent = "Redirecting…";

      const priceId = PRICE_IDS[selectedPlan][selectedCycle];

      const payload = {
        priceId,
        plan: selectedPlan,
        cycle: selectedCycle,
        waiveConfirmed: true,
        userId: currentUserId,
        idempotencyKey: (crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + "_" + String(Date.now())),
        client: {
          nonce: makeClientNonce(),
          tzOffsetMinutes: new Date().getTimezoneOffset(),
          lang: navigator.language || "",
          ua: navigator.userAgent || "",
          ref: document.referrer || "",
          screen: {
            w: window.screen?.width || 0,
            h: window.screen?.height || 0,
            dpr: window.devicePixelRatio || 1
          }
        }
      };

      try{
        const { res, data } = await postWithTimeout("/api/create-checkout-session", payload, 12000);

        if(!res.ok){
          const msg = data?.error || data?.message || "Checkout failed.";
          throw new Error(msg);
        }

        if(!data?.url){
          throw new Error("No checkout URL returned.");
        }

        showOk("Opening Stripe Checkout…");
        window.location.href = data.url;

      }catch(e){
        const msg = (e && e.name === "AbortError") ? "Checkout timed out. Try again." : (e?.message || "Something went wrong.");
        showErr(msg);
        checkoutLock = false;
        els.checkoutBtn.textContent = "Checkout";
        updateCheckoutEnabled();
      }
    }

    // =========================
    // PLAN/CYCLE
    // =========================
    function setCycle(cycle){
      selectedCycle = cycle;

      els.cycleMonthly.classList.toggle("active", cycle==="monthly");
      els.cycleQuarterly.classList.toggle("active", cycle==="quarterly");
      els.cycleAnnual.classList.toggle("active", cycle==="annual");

      els.cycleExplain.innerHTML = cycleExplainText();

      renderCards();
      renderBasket();
      renderFeatures();

      toast(`Billing cycle: ${CYCLE_LABEL[cycle]}`);
    }

    function setPlan(plan){
      selectedPlan = plan;

      els.cardPlus.classList.toggle("selected", plan==="plus");
      els.cardPro.classList.toggle("selected", plan==="pro");

      els.pickedSummary.textContent = `${CYCLE_LABEL[selectedCycle]} · ${plan==="pro"?"Pro":"Plus"}`;

      renderBasket();

      toast(`Selected: ${plan==="pro"?"Pro":"Plus"}`);
    }

    // =========================
    // ACTIONS
    // =========================
    function copySummary(){
      const plan = selectedPlan === "pro" ? "Pro" : "Plus";
      const cycle = CYCLE_LABEL[selectedCycle];
      const price = money(DISPLAY_PRICES[selectedPlan][selectedCycle]);
      navigator.clipboard.writeText(`ReviseFlow ${plan} · ${cycle} · ${price}`).then(()=>toast("Copied!"));
    }

    function resetAll(){
      selectedPlan = "pro";
      selectedCycle = "annual";
      els.consentNow.checked = false;
      checkoutLock = false;
      lastCheckoutAt = 0;

      setCycle("annual");
      setPlan("pro");

      els.search.value = "";
      els.groupFilter.value = "all";

      renderFeatures();
      clearMsgs();

      els.checkoutBtn.textContent = "Checkout";
      updateCheckoutEnabled();

      toast("Reset");
    }

    function initFromQuery(){
      const p = new URLSearchParams(location.search);
      if(p.get("canceled")) showErr("Checkout canceled — your card wasn’t charged.");
      if(p.get("success")) showOk("Payment received. If your plan doesn’t update in a few seconds, refresh the app.");
    }

    // =========================
    // EVENTS
    // =========================
    els.cycleMonthly.addEventListener("click", ()=>setCycle("monthly"));
    els.cycleQuarterly.addEventListener("click", ()=>setCycle("quarterly"));
    els.cycleAnnual.addEventListener("click", ()=>setCycle("annual"));

    els.cardPlus.addEventListener("click", ()=>setPlan("plus"));
    els.cardPro.addEventListener("click", ()=>setPlan("pro"));

    els.cardPlus.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); setPlan("plus"); }});
    els.cardPro.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); setPlan("pro"); }});

    els.checkoutBtn.addEventListener("click", startCheckout);
    els.copyBtn.addEventListener("click", copySummary);

    els.clearSearchBtn.addEventListener("click", ()=>{
      els.search.value="";
      els.groupFilter.value="all";
      renderFeatures();
    });

    els.search.addEventListener("input", renderFeatures);
    els.groupFilter.addEventListener("change", renderFeatures);

    els.consentNow.addEventListener("change", ()=>{
      clearMsgs();
      updateCheckoutEnabled();
      if(els.consentNow.checked) toast("Ready to checkout");
    });

    els.backBtn.addEventListener("click", ()=>{
      window.history.length>1 ? window.history.back() : window.location.href="index.html";
    });

    els.refreshBtn.addEventListener("click", resetAll);

    // =========================
    // INIT
    // =========================
    (async function init(){
      buildGroupFilter();
      initFromQuery();

      // IMPORTANT: setCycle/setPlan triggers renders and sets initial prices
      setCycle("annual");
      setPlan("pro");
      renderCards();
      renderBasket();
      renderFeatures();

      await loadUser();

      if(!currentUserId){
        // If anon key is missing OR user isn't logged in
        showErr("Please sign in to purchase a subscription.");
      }

      updateCheckoutEnabled();
    })();
  </script>
</body>
</html>