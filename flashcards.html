<!doctype html>
<html lang="en" data-theme="dark">
<head>
<script src="theme.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReviseFlow ‚Äî Flashcards</title>
  <meta name="description" content="ReviseFlow flashcards: revise terms and meanings with smart progress tracking." />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1020;
      --bg2:#070a14;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --brand:#8ea2ff;
      --good:#46e6b3;
      --danger:#ff5b6e;
      --radius:18px;
      --shadow: 0 18px 60px rgba(0,0,0,.38);
      --focus: rgba(142,162,255,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      /* AI panel width (pushes layout left) */
      --aiW: 520px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(142,162,255,.18), transparent 55%),
        radial-gradient(1000px 700px at 95% 0%, rgba(70,230,179,.14), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
      transition: padding-right .22s ease;
    }

    /* When AI opens, push content left (no overlap) */
    body.ai-open{ padding-right: var(--aiW); }

    a{ color:inherit; text-decoration:none; }

    .wrap{
      max-width:1180px;
      width:100%;
      margin:0 auto;
      padding:22px 18px 72px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:2px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.20);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:linear-gradient(135deg,var(--brand),var(--good)); }
    .brandTitle{ font-weight:900; font-size:14px; line-height:1.1; }
    .brandSub{ font-size:12px; color:var(--muted); }

    .nav{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background:rgba(255,255,255,.07); transform: translateY(-1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btn.primary{
      border:none;
      color:#111;
      background:linear-gradient(135deg,var(--brand),var(--good));
    }
    .btn.danger{
      border-color: rgba(255,91,110,.28);
      background: rgba(255,91,110,.12);
      color:#ffd2d8;
    }
    .btn.ghost{ background:rgba(255,255,255,.03); }

    .panel{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:var(--radius);
      padding:16px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      width:100%;
    }

    .statusPanel{ margin-top:6px; }
    .panelHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .hTitle{ font-weight:950; font-size:16px; margin:0; }
    .tiny{ font-size:12px; color:var(--muted); }
    .msg{ font-size:13px; color:var(--muted); }
    .msg.ok{ color: rgba(182,255,207,.90); }
    .msg.err{ color: #ffb3b3; }

    .layout{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .pickerHead{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:10px;
    }

    .searchRow{ display:flex; gap:10px; align-items:center; width:100%; }
    input[type="text"], textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      color:var(--text);
      outline:none;
    }
    input[type="text"]:focus, textarea:focus{
      border-color: rgba(142,162,255,.55);
      box-shadow: 0 0 0 4px var(--focus);
    }

    .setsList{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top:8px;
    }
    @media(max-width:900px){ .setsList{ grid-template-columns: 1fr; } }

    .setCard{
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:18px;
      padding:14px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      position:relative;
      overflow:hidden;
    }
    .setCard:hover{
      transform: translateY(-2px);
      background:rgba(255,255,255,.06);
      border-color: rgba(142,162,255,.24);
    }
    .setCard::before{
      content:"";
      position:absolute; inset:-40px -60px auto auto;
      width:180px; height:180px;
      background: radial-gradient(circle at 30% 30%, rgba(142,162,255,.22), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .setTitle{ font-weight:950; font-size:16px; margin:0 0 6px 0; }
    .setDesc{ font-size:13px; color:var(--muted); line-height:1.35; margin:0 0 10px 0; white-space:pre-wrap; }
    .setMeta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge{
      font-size:12px;
      padding:5px 9px;
      border-radius:999px;
      background:rgba(142,162,255,.18);
      border:1px solid rgba(142,162,255,.25);
      color:rgba(255,255,255,.88);
      white-space:nowrap;
    }
    .pill{
      font-size:12px;
      padding:5px 9px;
      border-radius:999px;
      background:rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.86);
      white-space:nowrap;
    }

    /* Flash view */
    .hidden{ display:none !important; }

    .flashHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .flashTitle{ font-weight:950; font-size:18px; margin:0; }
    .flashMeta{ font-size:12px; color:var(--muted); margin-top:4px; white-space:pre-wrap; }
    .flashActions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .barWrap{
      width:100%;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      margin-bottom:12px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(142,162,255,.55), rgba(70,230,179,.55));
      transition: width .18s ease;
    }

    /* Flip card */
    .card3d{
      perspective: 1100px;
    }
    .flashCard{
      min-height: 280px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 340px at 20% 0%, rgba(142,162,255,.10), transparent 55%),
        rgba(255,255,255,.03);
      padding: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      cursor:pointer;
      position:relative;
      user-select:none;
      box-shadow: 0 14px 44px rgba(0,0,0,.32);
      outline:none;

      transform-style: preserve-3d;
      transition: transform .55s cubic-bezier(.2,.9,.2,1);
    }
    .flashCard:focus{ border-color: rgba(142,162,255,.40); box-shadow: 0 0 0 4px var(--focus), 0 14px 44px rgba(0,0,0,.32); }
    .flashCard.is-flipped{ transform: rotateY(180deg); }

    .face{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 26px;
      backface-visibility:hidden;
      transform: translateZ(1px);
    }
    .face.back{
      transform: rotateY(180deg) translateZ(1px);
    }

    .corner{
      position:absolute;
      top:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      font-size:12px;
      color: rgba(255,255,255,.88);
      z-index:3;
    }
    .corner.left{ left:12px; }
    .corner.right{ right:12px; cursor:pointer; }

    .flashText{
      font-size: 28px;
      line-height: 1.22;
      font-weight: 950;
      max-width: 900px;
      white-space:pre-wrap;
      word-break:break-word;
    }

    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .controls .group{ display:flex; gap:10px; flex-wrap:wrap; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media(max-width:900px){ .grid2{ grid-template-columns: 1fr; } }

    .subPanel{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      background: rgba(255,255,255,.03);
    }
    .subTitle{ font-weight:950; margin:0 0 8px 0; }
    .mono{
      font-family: var(--mono);
      font-size:12px;
      color: rgba(255,255,255,.82);
      white-space:pre-wrap;
      line-height:1.35;
    }

    /* ===== AI PANEL ===== */
    .aiFab{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 3500;
      border-radius: 999px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
    }

    .aiPanel{
      position: fixed;
      top: 0;
      right: 0;
      width: var(--aiW);
      max-width: 92vw;
      height: 100vh;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-left: 1px solid var(--border);
      box-shadow: -20px 0 60px rgba(0,0,0,.35);
      display: none;
      flex-direction: column;
      z-index: 3000;
      backdrop-filter: blur(14px);
    }

    .aiHeader{
      padding:16px 16px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .aiHeader .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .aiHeader .title b{ font-size:14px; letter-spacing:.2px; }
    .aiHeader .title small{ color:var(--muted); font-size:12px; }

    .aiBody{
      padding:16px;
      overflow:auto;
      flex:1;
    }

    .quickRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:10px 0 12px;
    }

    .aiOut{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      white-space:pre-wrap;
      min-height:140px;
      font-size:13px;
      color: rgba(255,255,255,.86);
    }

    @media(max-width:960px){
      /* On small screens, AI overlays instead of pushing */
      body.ai-open{ padding-right: 0; }
      .aiPanel{ width: 100vw; max-width:100vw; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <div class="brandTitle">ReviseFlow</div>
          <div class="brandSub">Flashcards</div>
        </div>
      </div>

      <div class="nav">
        <a class="btn ghost" href="index.html">Dashboard</a>
        <a class="btn ghost" href="studysets.html">Sets</a>
        <a class="btn ghost" href="tasks.html">Tasks</a>
        <a class="btn ghost" href="exam.html">Exam</a>
        <a class="btn ghost" href="account.html">Settings</a>
        <button class="btn danger" id="logoutBtn">Logout</button>
      </div>
    </div><!-- ‚úÖ IMPORTANT: topbar properly closed -->

    <div class="panel statusPanel">
      <div class="panelHead">
        <div>
          <div class="hTitle">What would you like to revise?</div>
          <div class="tiny">Pick a set, then run flashcards.</div>
        </div>
        <div class="tiny" id="whoBox"></div>
      </div>
      <div class="msg" id="statusMsg">Loading‚Ä¶</div>
    </div>

    <div class="layout">
      <!-- SET PICKER -->
      <div class="panel" id="setPicker">
        <div class="pickerHead">
          <div>
            <div class="hTitle">Choose a set</div>
            <div class="tiny">Search by name, subject, or description.</div>
          </div>

          <div class="searchRow" style="max-width:520px;">
            <input id="setSearch" type="text" placeholder="Search sets‚Ä¶" />
            <button class="btn" id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div class="setsList" id="setsList"></div>

        <div class="tiny hidden" id="setsEmpty" style="padding-top:10px;">
          No sets found. Create one in <a href="studysets.html" style="text-decoration:underline;">Sets</a>.
        </div>
      </div>

      <!-- FLASHCARDS VIEW -->
      <div class="panel hidden" id="flashView">
        <div class="flashHead">
          <div>
            <div class="flashTitle" id="activeSetTitle">Set</div>
            <div class="flashMeta" id="activeSetMeta"></div>
          </div>

          <div class="flashActions">
            <button class="btn" id="changeSetBtn">‚Üê Change set</button>
            <button class="btn" id="shuffleBtn">Shuffle</button>
            <button class="btn" id="toggleOnlyDueBtn">Only due: Off</button>
            <button class="btn" id="restartBtn">Restart</button>
            <button class="btn" id="modeLearnBtn">Learn Mode</button>
            <button class="btn" id="modeTestBtn">Test Mode</button>
            <button class="btn" id="modeExamBtn">Exam Mode</button>
          </div>
        </div>

        <div class="barWrap" aria-label="progress">
          <div class="bar" id="progressBar"></div>
        </div>

        <div class="card3d">
          <div class="flashCard" id="flashCard" tabindex="0" role="button" aria-label="flashcard (click to flip)">
            <div class="corner left" id="cardCounter">0 / 0</div>
            <div class="corner right" id="starBadge" title="Star">‚òÜ</div>

            <div class="face front">
              <div class="flashText" id="frontText">Loading‚Ä¶</div>
            </div>

            <div class="face back">
              <div class="flashText" id="backText">Loading‚Ä¶</div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="group">
            <button class="btn" id="prevBtn">‚Üê Prev</button>
            <button class="btn primary" id="flipBtn">Flip</button>
            <button class="btn" id="nextBtn">Next ‚Üí</button>
          </div>
          <div class="group">
            <button class="btn" id="againBtn">Again</button>
            <button class="btn primary" id="knowBtn">Know</button>
            <button class="btn" id="starBtn">Star</button>
          </div>
        </div>

        <div class="grid2">
          <div class="subPanel">
            <div class="subTitle">Session stats</div>
            <div class="mono" id="statsBox">‚Äî</div>
          </div>

          <div class="subPanel">
            <div class="subTitle">Notes</div>
            <div class="mono" id="notesBox">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- AI floating button -->
  <button class="btn aiFab" id="btnOpenAi">ü§ñ AI</button>

  <!-- AI panel -->
  <aside class="aiPanel" id="aiPanel" aria-hidden="true">
    <div class="aiHeader">
      <div class="title">
        <b>ReviseFlow AI</b>
        <small>Quick questions while revising</small>
      </div>
      <button class="btn" id="btnCloseAi">‚úï</button>
    </div>

    <div class="aiBody">
      <div class="tiny">Quick prompts</div>
      <div class="quickRow">
        <button class="btn" data-q="Explain this simply: ">Explain simply</button>
        <button class="btn" data-q="Explain step-by-step in detail: ">Explain in detail</button>
        <button class="btn" data-q="Give me a GCSE exam-style question on: ">Exam question</button>
        <button class="btn" data-q="Make 5 flashcards (front/back) for: ">Make flashcards</button>
        <button class="btn" data-q="Give me 6 multiple choice questions on: ">MCQs</button>
      </div>

      <div class="tiny" style="margin-top:6px;">Your question</div>
      <textarea id="aiInput" placeholder="Ask anything about your topic‚Ä¶" maxlength="800"></textarea>

      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button class="btn primary" id="btnAskAi">‚ú® Ask</button>
        <button class="btn" id="btnAiClear">Clear</button>
      </div>

      <div class="aiOut" id="aiOutput">Your answer will appear here.</div>
    </div>
  </aside>

<script>
(()=>{

  /* ===== Client init ===== */
  const SUPABASE_URL = "https://mgpwknnbhaljsscsvucm.supabase.co";
  const SUPABASE_KEY = "sb_publishable_6tdnozSH6Ck75uDgXPN-sg_Mn7vyLFs";

  if (!window.supabaseClient) {
    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }
  const sb = window.supabaseClient;

  const $ = (id) => document.getElementById(id);

  const state = {
    user: null,

    sets: [],
    setCounts: new Map(), // set_id -> count
    set: null,

    items: [],
    progressMap: new Map(), // item_id -> progress row
    progressEnabled: true,

    deck: [],
    index: 0,
    showingBack: false,
    onlyDue: false,

    session: { startedAt: Date.now(), flips:0, knows:0, agains:0, starsToggled:0 },
    mode: "learn"
  };

  function escapeHTML(str) {
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setStatus(text, kind="muted"){
    const el = $("statusMsg");
    el.className = "msg " + (kind === "err" ? "err" : kind === "ok" ? "ok" : "");
    el.textContent = text;
  }

  function nowISO(){ return new Date().toISOString(); }
  function addDaysISO(daysFloat){
    const ms = daysFloat * 24 * 60 * 60 * 1000;
    return new Date(Date.now() + ms).toISOString();
  }
  function fmtDate(iso){
    if(!iso) return "Now";
    try { return new Date(iso).toLocaleString(); } catch { return String(iso); }
  }
  function fmtShortDate(iso){
    if(!iso) return "‚Äî";
    try { return new Date(iso).toLocaleDateString(); } catch { return String(iso); }
  }

  function getParam(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  async function requireSession(){
    const { data:{ session }, error } = await sb.auth.getSession();
    if(error){
      setStatus("Auth error: " + error.message, "err");
      return null;
    }
    if(!session){
      window.location.href = "auth.html";
      return null;
    }

    sb.auth.onAuthStateChange((_evt, sess) => {
      if(!sess) window.location.href = "auth.html";
    });

    return session;
  }

  async function logout(){
    await sb.auth.signOut();
    window.location.href = "auth.html";
  }

  /* ===== Sets ===== */
  async function loadSets(){
    setStatus("Loading your sets‚Ä¶");

    const { data, error } = await sb
      .from("study_sets")
      .select("id,name,subject,description,created_at,updated_at,user_id")
      .or(`user_id.eq.${state.user.id},is_public.eq.true`)
      .order("updated_at", { ascending:false });

    if(error){
      setStatus("Could not load sets: " + error.message, "err");
      state.sets = [];
      renderSets();
      return;
    }

    state.sets = data || [];
    await loadSetCounts();
    renderSets();

    if(state.sets.length){
      setStatus("Pick a set to start.", "ok");
    }else{
      setStatus("No sets yet ‚Äî create one in Sets.", "muted");
    }
  }

  async function loadSetCounts(){
    state.setCounts = new Map();
    const ids = state.sets.map(s => s.id);
    if(!ids.length) return;

    let res = await sb
      .from("study_terms")
      .select("set_id,user_id")
      .in("set_id", ids)
      .eq("user_id", state.user.id);

    if(res.error && String(res.error.message || "").toLowerCase().includes("user_id")){
      res = await sb
        .from("study_terms")
        .select("set_id")
        .in("set_id", ids);
    }

    if(res.error){
      console.warn("Count load error:", res.error.message);
      return;
    }

    for(const row of (res.data || [])){
      const k = row.set_id;
      state.setCounts.set(k, (state.setCounts.get(k) || 0) + 1);
    }
  }

  function renderSets(){
    const list = $("setsList");
    const empty = $("setsEmpty");
    list.innerHTML = "";

    const q = ($("setSearch").value || "").trim().toLowerCase();

    const filtered = q
      ? state.sets.filter(s => {
          const name = (s.name || "").toLowerCase();
          const subj = (s.subject || "").toLowerCase();
          const desc = (s.description || "").toLowerCase();
          return name.includes(q) || subj.includes(q) || desc.includes(q);
        })
      : state.sets;

    empty.classList.toggle("hidden", filtered.length !== 0);

    for(const s of filtered){
      const count = state.setCounts.get(s.id) || 0;

      const div = document.createElement("div");
      div.className = "setCard";
      div.innerHTML = `
        <div class="setTitle">${escapeHTML(s.name || "Untitled set")}</div>
        <div class="setDesc">${escapeHTML((s.description || "").trim() || "No description.")}</div>
        <div class="setMeta">
          <span class="badge">${escapeHTML(s.subject || "General")}</span>
          <span class="pill">${count} card${count===1?"":"s"}</span>
          <span class="pill">Updated: ${s.updated_at ? fmtShortDate(s.updated_at) : "‚Äî"}</span>
        </div>
      `;
      div.addEventListener("click", () => openSet(s));
      list.appendChild(div);
    }
  }

  /* ===== Cards ===== */
  async function loadCards(setId){
    setStatus("Loading cards‚Ä¶");

    let res = await sb
      .from("study_terms")
      .select("id,set_id,term,definition,created_at,updated_at,user_id")
      .eq("set_id", setId)
      .eq("user_id", state.user.id)
      .order("created_at", { ascending:true });

    if(res.error && String(res.error.message || "").toLowerCase().includes("user_id")){
      res = await sb
        .from("study_terms")
        .select("id,set_id,term,definition,created_at,updated_at")
        .eq("set_id", setId)
        .order("created_at", { ascending:true });
    }

    if(res.error){
      setStatus("Could not load cards: " + res.error.message, "err");
      state.items = [];
      return false;
    }

    state.items = res.data || [];
    return true;
  }

  /* ===== Progress (optional) ===== */
  async function loadProgress(setId){
    state.progressMap = new Map();
    state.progressEnabled = true;

    const res = await sb
      .from("flashcard_progress")
      .select("user_id,item_id,set_id,starred,reps,lapses,interval_days,due_at,last_result,updated_at")
      .eq("user_id", state.user.id)
      .eq("set_id", setId);

    if(res.error){
      console.warn("Progress disabled:", res.error.message);
      state.progressEnabled = false;
      return;
    }

    for(const r of (res.data || [])){
      state.progressMap.set(r.item_id, r);
    }
  }

  function normalizeProgressRow(itemId, overrides = {}){
    const base = state.progressMap.get(itemId) || {};
    return {
      user_id: state.user.id,
      item_id: itemId,
      set_id: state.set.id,
      starred: !!base.starred,
      reps: Number(base.reps ?? 0),
      lapses: Number(base.lapses ?? 0),
      interval_days: Number(base.interval_days ?? 0),
      due_at: base.due_at || null,
      last_result: base.last_result || null,
      updated_at: nowISO(),
      ...overrides
    };
  }

  async function upsertProgress(row){
    if(!state.progressEnabled) return true;

    const res = await sb
      .from("flashcard_progress")
      .upsert(row, { onConflict: "user_id,item_id" });

    if(res.error){
      console.warn("Upsert failed:", res.error.message);
      state.progressEnabled = false;
      return false;
    }
    return true;
  }

  /* ===== Deck + UI ===== */
  function buildDeck(){
    const now = Date.now();

    const rows = state.items.map(it => {
      const p = state.progressMap.get(it.id) || null;
      const dueAt = p?.due_at ? new Date(p.due_at).getTime() : 0;
      const isDue = !p?.due_at || dueAt <= now;
      return { it, p, isDue };
    });

    const chosen = state.onlyDue ? rows.filter(r => r.isDue) : rows;
    state.deck = chosen.length ? chosen : rows;

    state.index = 0;
    state.showingBack = false;
    renderCard();
  }

  function current(){ return state.deck[state.index] || null; }

  function setFlipped(isFlipped){
    state.showingBack = !!isFlipped;
    const card = $("flashCard");
    card.classList.toggle("is-flipped", state.showingBack);
  }

  function renderCard(){
    const c = current();
    const total = state.deck.length;

    $("prevBtn").disabled = state.index <= 0;
    $("nextBtn").disabled = state.index >= total - 1;

    if(!c){
      $("frontText").textContent = "No cards in this set yet.";
      $("backText").textContent = "No cards in this set yet.";
      $("cardCounter").textContent = "0 / 0";
      $("progressBar").style.width = "0%";
      $("starBadge").textContent = "‚òÜ";
      setFlipped(false);
      renderStats();
      renderNotes();
      return;
    }

    const front = c.it.term || "(no term)";
    const back = c.it.definition || "(no definition)";
    $("frontText").textContent = front;
    $("backText").textContent = back;

    $("cardCounter").textContent = `${state.index + 1} / ${total}`;
    $("progressBar").style.width = `${Math.round(((state.index + 1) / Math.max(1,total)) * 100)}%`;

    const starred = !!c.p?.starred;
    $("starBadge").textContent = starred ? "‚òÖ" : "‚òÜ";

    setFlipped(false);
    renderStats();
    renderNotes();
  }

  function flip(){
    if(!current()) return;
    setFlipped(!state.showingBack);
    state.session.flips += 1;
    renderStats();
  }

  function next(){
    if(state.index < state.deck.length - 1){
      state.index += 1;
      setFlipped(false);
      renderCard();
    }
  }

  function prev(){
    if(state.index > 0){
      state.index -= 1;
      setFlipped(false);
      renderCard();
    }
  }

  function shuffleDeck(){
    for(let i = state.deck.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [state.deck[i], state.deck[j]] = [state.deck[j], state.deck[i]];
    }
    state.index = 0;
    setFlipped(false);
    renderCard();
  }

  function restartSession(){
    state.index = 0;
    setFlipped(false);
    state.session = { startedAt: Date.now(), flips:0, knows:0, agains:0, starsToggled:0 };
    renderCard();
  }

  async function toggleStar(){
    const c = current();
    if(!c) return;

    const currently = !!c.p?.starred;
    const row = normalizeProgressRow(c.it.id, { starred: !currently });

    const ok = await upsertProgress(row);
    if(state.progressEnabled && !ok){
      setStatus("Progress saving unavailable.", "muted");
    }

    c.p = { ...(c.p || {}), ...row };
    state.progressMap.set(c.it.id, c.p);
    state.session.starsToggled += 1;
    renderCard();
  }

  async function markAgain(){
    const c = current();
    if(!c) return;

    state.session.agains += 1;
    if(state.mode === "test"){ setStatus("Scored: Again", "muted"); }

    const lapses = Number(c.p?.lapses ?? 0) + 1;
    const reps = Number(c.p?.reps ?? 0) + 1;

    /* short retry: ~6 hours */
    const newInterval = 0.25;

    const row = normalizeProgressRow(c.it.id, {
      last_result: "again",
      reps,
      lapses,
      interval_days: newInterval,
      due_at: addDaysISO(newInterval)
    });

    const ok = await upsertProgress(row);
    if(state.progressEnabled && !ok){
      setStatus("Progress saving unavailable.", "muted");
    }

    c.p = { ...(c.p || {}), ...row };
    state.progressMap.set(c.it.id, c.p);

    next();
  }

  async function markKnow(){
    const c = current();
    if(!c) return;

    state.session.knows += 1;
    if(state.mode === "test"){ setStatus("Scored: Correct", "ok"); }

    const reps = Number(c.p?.reps ?? 0) + 1;
    const lapses = Number(c.p?.lapses ?? 0);
    const prevInterval = Number(c.p?.interval_days ?? 0);

    /* simple spaced repetition ladder */
    let newInterval;
    if(prevInterval < 0.5) newInterval = 1;
    else if(prevInterval < 1.5) newInterval = 2;
    else if(prevInterval < 3) newInterval = 4;
    else if(prevInterval < 6) newInterval = 7;
    else if(prevInterval < 12) newInterval = 14;
    else if(prevInterval < 25) newInterval = 30;
    else newInterval = Math.min(120, Math.round(prevInterval * 1.8));

    const row = normalizeProgressRow(c.it.id, {
      last_result: "know",
      reps,
      lapses,
      interval_days: newInterval,
      due_at: addDaysISO(newInterval)
    });

    const ok = await upsertProgress(row);
    if(state.progressEnabled && !ok){
      setStatus("Progress saving unavailable.", "muted");
    }

    c.p = { ...(c.p || {}), ...row };
    state.progressMap.set(c.it.id, c.p);

    next();
  }

  function renderStats(){
    const c = current();
    if(!c){
      $("statsBox").textContent = "‚Äî";
      return;
    }

    const p = c.p || {};
    const due = fmtDate(p.due_at);
    const interval = Number(p.interval_days ?? 0);
    const reps = Number(p.reps ?? 0);
    const lapses = Number(p.lapses ?? 0);

    const s = state.session;
    $("statsBox").textContent =
      `Due: ${due}
Interval: ${interval} day(s)
Reps: ${reps} ‚Ä¢ Lapses: ${lapses}
Starred: ${p.starred ? "Yes" : "No"}

Session:
Flips: ${s.flips}
Know: ${s.knows}
Again: ${s.agains}
Stars toggled: ${s.starsToggled}`;
  }

  function renderNotes(){
    const lines = [];

    lines.push(state.progressEnabled ? "Progress saving is active." : "Progress saving is currently unavailable.");
    lines.push("");

    lines.push("Shortcuts:");
    lines.push("Space = Flip");
    lines.push("‚Üê / ‚Üí = Prev / Next");
    lines.push("K = Know");
    lines.push("A = Again");
    lines.push("S = Star");
    lines.push("R = Restart");
    lines.push("H = Shuffle");
    lines.push("");

    lines.push("Open a set directly:");
    lines.push("flashcards.html?set=<setId>");

    $("notesBox").textContent = lines.join("\n");
  }

  /* ===== Open / Close set ===== */
  async function openSet(setRow){
    state.set = setRow;
    localStorage.setItem("rf:lastSetId", setRow.id);

    $("setPicker").classList.add("hidden");
    $("flashView").classList.remove("hidden");

    $("activeSetTitle").textContent = setRow.name || "Untitled set";

    const metaBits = [];
    metaBits.push(`Subject: ${setRow.subject || "General"}`);
    if(setRow.description) metaBits.push(setRow.description);
    metaBits.push(`Created: ${setRow.created_at ? fmtShortDate(setRow.created_at) : "‚Äî"}`);
    $("activeSetMeta").textContent = metaBits.join(" ‚Ä¢ ");

    const ok = await loadCards(setRow.id);
    await loadProgress(setRow.id);

    state.onlyDue = false;
    $("toggleOnlyDueBtn").textContent = "Only due: Off";

    if(!ok) return;

    if(!state.items.length){
      setStatus("This set has no cards yet. Add some in Sets.", "muted");
    }else{
      setStatus("Revising‚Ä¶", "ok");
    }

    restartSession();
    buildDeck();
    $("flashCard").focus();
  }

  function backToSets(){
    state.set = null;
    state.items = [];
    state.progressMap = new Map();
    state.deck = [];
    state.index = 0;
    state.showingBack = false;

    $("flashView").classList.add("hidden");
    $("setPicker").classList.remove("hidden");

    setStatus(state.sets.length ? "Pick a set to start." : "No sets yet ‚Äî create one in Sets.", state.sets.length ? "ok" : "muted");
  }

  /* ===== AI Panel ===== */
  function openAi(){
    $("aiPanel").style.display = "flex";
    $("aiPanel").setAttribute("aria-hidden", "false");
    document.body.classList.add("ai-open");
  }
  function closeAi(){
    $("aiPanel").style.display = "none";
    $("aiPanel").setAttribute("aria-hidden", "true");
    document.body.classList.remove("ai-open");
  }

  async function askAI(){
    const input = ($("aiInput").value || "").trim();
    const out = $("aiOutput");

    if(!input){
      out.textContent = "Type a question first.";
      return;
    }

    out.textContent = "Thinking...";

    try{
      const { data: { session } } = await sb.auth.getSession();
      if(!session){
        out.textContent = "Please log in again.";
        window.location.href = "auth.html";
        return;
      }

      const result = window.rfRequestAI ? await window.rfRequestAI(input) : null;
      if (!result) {
        out.textContent = "AI service unavailable.";
        return;
      }

      if(result.status === 429){
        out.textContent = result.data?.error || "Daily AI limit reached.";
        return;
      }

      if(result.status === 401){
        out.textContent = "Session expired. Please log in again.";
        window.location.href = "auth.html";
        return;
      }

      out.textContent = result.data?.reply || result.data?.error || "Something went wrong.";
    }catch(e){
      console.error("AI error:", e);
      out.textContent = "Error contacting AI service.";
    }
  }



  function setMode(mode){
    state.mode = mode;
    setStatus(`Mode: ${mode[0].toUpperCase()+mode.slice(1)}`, "ok");
  }

  /* ===== Events ===== */
  function bindEvents(){
    $("logoutBtn").addEventListener("click", logout);
    $("refreshBtn").addEventListener("click", loadSets);
    $("setSearch").addEventListener("input", renderSets);

    $("changeSetBtn").addEventListener("click", backToSets);

    $("flashCard").addEventListener("click", flip);
    $("flipBtn").addEventListener("click", flip);

    $("nextBtn").addEventListener("click", next);
    $("prevBtn").addEventListener("click", prev);

    $("shuffleBtn").addEventListener("click", () => { shuffleDeck(); setStatus("Shuffled ‚úÖ", "ok"); });
    $("restartBtn").addEventListener("click", () => { restartSession(); setStatus("Restarted ‚úÖ", "ok"); });
    $("modeLearnBtn").addEventListener("click", () => setMode("learn"));
    $("modeTestBtn").addEventListener("click", () => setMode("test"));
    $("modeExamBtn").addEventListener("click", () => { setMode("exam"); window.location.href = "exam.html"; });

    $("toggleOnlyDueBtn").addEventListener("click", () => {
      state.onlyDue = !state.onlyDue;
      $("toggleOnlyDueBtn").textContent = `Only due: ${state.onlyDue ? "On" : "Off"}`;
      buildDeck();
      renderCard();
    });

    $("starBtn").addEventListener("click", toggleStar);
    $("starBadge").addEventListener("click", (e) => { e.stopPropagation(); toggleStar(); });

    $("againBtn").addEventListener("click", markAgain);
    $("knowBtn").addEventListener("click", markKnow);

    window.addEventListener("keydown", (e) => {
      if($("flashView").classList.contains("hidden")) return;

      const k = e.key.toLowerCase();

      if(k === " "){ e.preventDefault(); flip(); }
      else if(k === "arrowright"){ next(); }
      else if(k === "arrowleft"){ prev(); }
      else if(k === "k"){ markKnow(); }
      else if(k === "a"){ markAgain(); }
      else if(k === "s"){ toggleStar(); }
      else if(k === "r"){ restartSession(); setStatus("Restarted ‚úÖ", "ok"); }
      else if(k === "h"){ shuffleDeck(); setStatus("Shuffled ‚úÖ", "ok"); }

      if(k === "escape" && document.body.classList.contains("ai-open")){
        closeAi();
      }
    });

    /* AI wiring */
    $("btnOpenAi").addEventListener("click", openAi);
    $("btnCloseAi").addEventListener("click", closeAi);
    $("btnAskAi").addEventListener("click", askAI);
    $("btnAiClear").addEventListener("click", ()=>{
      $("aiInput").value = "";
      $("aiOutput").textContent = "Your answer will appear here.";
    });

    document.querySelectorAll("[data-q]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const prefix = btn.getAttribute("data-q") || "";
        const current = ($("aiInput").value || "").trim();
        $("aiInput").value = current ? (prefix + current) : prefix;
        $("aiInput").focus();
      });
    });
  }

  /* ===== Init ===== */
  (async function init(){
    bindEvents();

    const session = await requireSession();
    if(!session) return;

    state.user = session.user;
    const { data: settings } = await sb.from("user_settings").select("username").eq("user_id", state.user.id).maybeSingle();
    $("whoBox").textContent = settings?.username || "User";

    await loadSets();

    const paramSet = getParam("set") || getParam("id");
    const lastSet = localStorage.getItem("rf:lastSetId");
    const wanted = paramSet || lastSet;

    if(wanted && state.sets.length){
      const found = state.sets.find(s => s.id === wanted);
      if(found) openSet(found);
    }
  })();

})();
</script>
<script src="ai-sidebar.js"></script>
</body>
</html>