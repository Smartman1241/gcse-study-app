<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReviseFlow — Flashcards</title>
  <meta name="description" content="ReviseFlow flashcards: revise terms and meanings with smart progress tracking." />

  <!-- Reuse your existing styles if you have them -->
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    /* Minimal extra styling (safe even if your styles.css exists) */
    .page { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand .dot { width:10px; height:10px; border-radius:999px; background: currentColor; opacity:.9; }
    .muted { opacity:.75; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .cardBox { display:grid; grid-template-columns: 1fr; gap:12px; }
    .panel { border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:14px; background: rgba(255,255,255,.03); }
    .panelHeader { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid2 { grid-template-columns: 1fr; } }

    .btn { border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.04); color:inherit;
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600; }
    .btn:hover { background: rgba(255,255,255,.07); }
    .btn.primary { background: rgba(255,255,255,.12); }
    .btn.danger { border-color: rgba(255,90,90,.35); }
    .btn:disabled { opacity:.45; cursor:not-allowed; }

    select, input[type="text"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.18); color:inherit;
    }

    .setsList { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    @media (max-width: 900px){ .setsList { grid-template-columns: 1fr; } }

    .setCard { border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:14px; background: rgba(255,255,255,.03); cursor:pointer; }
    .setCard:hover { background: rgba(255,255,255,.06); }
    .setTitle { font-size: 16px; font-weight:800; margin: 0 0 6px 0; }
    .setMeta { display:flex; gap:10px; flex-wrap:wrap; font-size: 12px; opacity:.8; }

    .flashWrap { display:grid; gap:12px; }
    .progressBarWrap { width:100%; height:10px; border-radius:999px; background: rgba(255,255,255,.08); overflow:hidden; }
    .progressBar { height:100%; width:0%; background: rgba(255,255,255,.30); }

    .flashCard {
      min-height: 260px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      padding: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      cursor:pointer;
      position:relative;
      user-select:none;
    }
    .flashCard .badge {
      position:absolute; top:12px; left:12px;
      font-size:12px; opacity:.8;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
    }
    .flashCard .star {
      position:absolute; top:12px; right:12px;
      font-size:14px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
    }
    .flashText { font-size: 26px; line-height: 1.25; font-weight: 800; padding: 18px; }
    .flashHint { position:absolute; bottom:12px; left:12px; right:12px; font-size: 12px; opacity:.7; display:flex; justify-content:space-between; gap:10px; }
    .pill { font-size:12px; opacity:.85; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.16); }

    .tiny { font-size: 12px; opacity:.75; }
    .error { color: #ffb3b3; }
    .ok { color: #b6ffcf; }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px; border:1px solid rgba(255,255,255,.18); padding:2px 6px; border-radius:6px; opacity:.9; }

    .hidden { display:none !important; }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <div style="font-weight:900; font-size:16px;">ReviseFlow</div>
          <div class="muted" style="font-size:12px;">Flashcards</div>
        </div>
      </div>

      <div class="row">
        <button id="backToSetsBtn" class="btn hidden">← Change set</button>
        <a class="btn" href="dashboard.html">Dashboard</a>
        <a class="btn" href="sets.html">Sets</a>
        <a class="btn" href="tasks.html">Tasks</a>
        <a class="btn" href="focus.html">Focus</a>
        <a class="btn" href="settings.html">Settings</a>
        <button id="logoutBtn" class="btn danger">Logout</button>
      </div>
    </div>

    <div id="statusBox" class="panel">
      <div class="panelHeader">
        <div>
          <div style="font-weight:900;">What would you like to revise?</div>
          <div class="muted tiny">Pick a set, then run flashcards with smart progress saving.</div>
        </div>
        <div id="whoBox" class="tiny muted"></div>
      </div>
      <div id="statusMsg" class="tiny muted">Loading…</div>
    </div>

    <!-- SET PICKER -->
    <div id="setPicker" class="panel">
      <div class="panelHeader">
        <div>
          <div style="font-weight:900;">Choose a set</div>
          <div class="muted tiny">Tip: you can search by name.</div>
        </div>
        <div style="min-width:280px;">
          <input id="setSearch" type="text" placeholder="Search sets…" />
        </div>
      </div>

      <div id="setsList" class="setsList"></div>
      <div id="setsEmpty" class="muted tiny hidden" style="padding-top:10px;">
        No sets found. Create one in <a href="sets.html">sets</a>.
      </div>
    </div>

    <!-- FLASHCARDS VIEW -->
    <div id="flashView" class="panel hidden">
      <div class="panelHeader">
        <div>
          <div id="activeSetTitle" style="font-weight:900;">Set</div>
          <div id="activeSetMeta" class="muted tiny"></div>
        </div>

        <div class="row">
          <button id="shuffleBtn" class="btn">Shuffle</button>
          <button id="toggleOnlyDueBtn" class="btn">Only due: Off</button>
          <button id="resetSessionBtn" class="btn">Restart</button>
        </div>
      </div>

      <div class="flashWrap">
        <div class="progressBarWrap" aria-label="progress">
          <div id="progressBar" class="progressBar"></div>
        </div>

        <div id="flashCard" class="flashCard" tabindex="0" role="button" aria-label="flashcard (click to flip)">
          <div class="badge" id="cardCounter">0 / 0</div>
          <div class="star" id="starBadge">☆</div>
          <div class="flashText" id="flashText">Loading…</div>
          <div class="flashHint">
            <span class="pill">Flip: <span class="kbd">Space</span></span>
            <span class="pill">Next/Prev: <span class="kbd">→</span> / <span class="kbd">←</span></span>
          </div>
        </div>

        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <button id="prevBtn" class="btn">← Prev</button>
            <button id="flipBtn" class="btn primary">Flip</button>
            <button id="nextBtn" class="btn">Next →</button>
          </div>

          <div class="row">
            <button id="againBtn" class="btn">Again</button>
            <button id="knowBtn" class="btn primary">Know</button>
            <button id="starBtn" class="btn">Star</button>
          </div>
        </div>

        <div class="grid2">
          <div class="panel">
            <div style="font-weight:900; margin-bottom:6px;">Session stats</div>
            <div class="tiny muted" id="statsBox">—</div>
          </div>

          <div class="panel">
            <div style="font-weight:900; margin-bottom:6px;">Shortcuts</div>
            <div class="tiny muted">
              <div><span class="kbd">Space</span> flip</div>
              <div><span class="kbd">→</span> next • <span class="kbd">←</span> prev</div>
              <div><span class="kbd">K</span> know • <span class="kbd">A</span> again</div>
              <div><span class="kbd">S</span> star</div>
              <div><span class="kbd">R</span> restart • <span class="kbd">H</span> shuffle</div>
            </div>
          </div>
        </div>

        <div class="tiny muted" id="saveNote">
          Progress saves automatically to your account.
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase: use your existing setup if you already have it -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /************************************************************
     * SUPABASE ADAPTER
     * ----------------------------------------------------------
     * This page expects a supabase client.
     *
     * If your project already sets `window.supabase` somewhere
     * (common.js / auth.js / app.js), this will use it.
     *
     * If not, uncomment and fill in your keys.
     ************************************************************/
    let sb = window.supabase;

    // If you DON'T have window.supabase, do this instead:
    // const SUPABASE_URL = "https://YOUR_PROJECT.supabase.co";
    // const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
    // sb = window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    if (!sb) {
      console.error("Supabase client not found. Set window.supabase or createClient in this file.");
    }

    /************************************************************
     * TABLES EXPECTED (same idea as sets.html)
     *
     * study_sets:
     *   id (uuid) PK
     *   user_id (uuid) references auth.users
     *   title (text)
     *   subject (text, optional)
     *   created_at (timestamptz)
     *
     * study_set_items:
     *   id (uuid) PK
     *   set_id (uuid) references study_sets(id)
     *   user_id (uuid) references auth.users
     *   term (text)
     *   definition (text)
     *   created_at (timestamptz)
     *
     * flashcard_progress:
     *   user_id (uuid)
     *   item_id (uuid)
     *   set_id (uuid)
     *   starred (boolean)
     *   reps (int)
     *   lapses (int)
     *   interval_days (float)
     *   due_at (timestamptz)
     *   last_result (text)  -- "know" / "again"
     *   updated_at (timestamptz)
     *   PRIMARY KEY (user_id, item_id)
     ************************************************************/

    const $ = (id) => document.getElementById(id);

    const state = {
      user: null,
      sets: [],
      items: [],
      progressMap: new Map(), // item_id -> progress row
      set: null,

      deck: [],
      index: 0,
      showingBack: false,
      onlyDue: false,

      session: {
        startedAt: Date.now(),
        flips: 0,
        knows: 0,
        agains: 0,
        starsToggled: 0
      }
    };

    function fmtDate(iso) {
      if (!iso) return "—";
      const d = new Date(iso);
      return d.toLocaleString();
    }

    function nowISO() {
      return new Date().toISOString();
    }

    function addDaysISO(daysFloat) {
      const ms = daysFloat * 24 * 60 * 60 * 1000;
      return new Date(Date.now() + ms).toISOString();
    }

    function setStatus(msg, kind="muted") {
      const el = $("statusMsg");
      el.className = "tiny " + (kind === "error" ? "error" : kind === "ok" ? "ok" : "muted");
      el.textContent = msg;
    }

    async function requireAuth() {
      if (!sb) {
        setStatus("Supabase client missing. Fix SUPABASE ADAPTER in flashcards.html.", "error");
        return false;
      }
      const { data, error } = await sb.auth.getUser();
      if (error) {
        setStatus("Auth error: " + error.message, "error");
        return false;
      }
      if (!data?.user) {
        window.location.href = "auth.html";
        return false;
      }
      state.user = data.user;
      $("whoBox").textContent = state.user.email || "";
      return true;
    }

    async function logout() {
      await sb.auth.signOut();
      window.location.href = "auth.html";
    }

    // --------- DATA LOADERS ---------
    async function loadSets() {
      setStatus("Loading your sets…");
      // Adjust these table/column names if your sets.html uses different ones.
      const { data, error } = await sb
        .from("study_sets")
        .select("id,title,subject,created_at")
        .eq("user_id", state.user.id)
        .order("created_at", { ascending: false });

      if (error) {
        setStatus("Could not load sets: " + error.message, "error");
        return;
      }
      state.sets = data || [];
      renderSets();
      setStatus(state.sets.length ? "Pick a set to start flashcards." : "No sets yet — create one in sets.", state.sets.length ? "ok" : "muted");
    }

    async function loadSetItems(setId) {
      setStatus("Loading set items…");
      const { data, error } = await sb
        .from("study_set_items")
        .select("id,set_id,term,definition,created_at")
        .eq("set_id", setId)
        .eq("user_id", state.user.id)
        .order("created_at", { ascending: true });

      if (error) {
        setStatus("Could not load set items: " + error.message, "error");
        return false;
      }
      state.items = data || [];
      return true;
    }

    async function loadProgress(setId) {
      // Pull all progress rows for this set for the current user.
      const { data, error } = await sb
        .from("flashcard_progress")
        .select("user_id,item_id,set_id,starred,reps,lapses,interval_days,due_at,last_result,updated_at")
        .eq("user_id", state.user.id)
        .eq("set_id", setId);

      if (error) {
        // Non-fatal: progress table might not exist yet
        console.warn("Progress load error:", error.message);
        state.progressMap = new Map();
        return;
      }
      state.progressMap = new Map((data || []).map(r => [r.item_id, r]));
    }

    // --------- RENDER: SETS ---------
    function renderSets() {
      const list = $("setsList");
      const empty = $("setsEmpty");
      list.innerHTML = "";

      const q = ($("setSearch").value || "").trim().toLowerCase();
      const filtered = state.sets.filter(s => (s.title || "").toLowerCase().includes(q));

      empty.classList.toggle("hidden", filtered.length !== 0);

      for (const s of filtered) {
        const div = document.createElement("div");
        div.className = "setCard";
        div.innerHTML = `
          <div class="setTitle">${escapeHTML(s.title || "Untitled set")}</div>
          <div class="setMeta">
            <span>Subject: <b>${escapeHTML(s.subject || "—")}</b></span>
            <span>Created: <b>${new Date(s.created_at).toLocaleDateString()}</b></span>
          </div>
        `;
        div.addEventListener("click", () => openSet(s));
        list.appendChild(div);
      }
    }

    function escapeHTML(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // --------- FLASHCARDS LOGIC ---------
    function buildDeck() {
      // base deck = items in set
      const now = Date.now();

      const rows = state.items.map(it => {
        const p = state.progressMap.get(it.id);
        const dueAt = p?.due_at ? new Date(p.due_at).getTime() : 0;
        const isDue = !p?.due_at || dueAt <= now;
        return { it, p: p || null, isDue };
      });

      const chosen = state.onlyDue ? rows.filter(r => r.isDue) : rows;

      // If onlyDue produces empty, fall back to all so user isn’t stuck
      state.deck = (chosen.length ? chosen : rows);

      state.index = 0;
      state.showingBack = false;
      updateUI();
    }

    function current() {
      return state.deck[state.index] || null;
    }

    function updateUI() {
      const c = current();
      const total = state.deck.length;

      $("prevBtn").disabled = state.index <= 0;
      $("nextBtn").disabled = state.index >= total - 1;

      if (!c) {
        $("flashText").textContent = "No cards in this set yet.";
        $("cardCounter").textContent = "0 / 0";
        $("progressBar").style.width = "0%";
        $("starBadge").textContent = "☆";
        $("statsBox").textContent = "—";
        return;
      }

      const front = c.it.term || "(no term)";
      const back = c.it.definition || "(no definition)";

      $("flashText").textContent = state.showingBack ? back : front;
      $("cardCounter").textContent = `${state.index + 1} / ${total}`;
      $("progressBar").style.width = `${Math.round(((state.index + 1) / Math.max(1,total)) * 100)}%`;

      const starred = !!c.p?.starred;
      $("starBadge").textContent = starred ? "★" : "☆";

      const due = c.p?.due_at ? fmtDate(c.p.due_at) : "Now";
      const interval = (c.p?.interval_days ?? 0);
      const reps = (c.p?.reps ?? 0);
      const lapses = (c.p?.lapses ?? 0);

      $("statsBox").textContent =
        `Due: ${due}\nInterval: ${interval} day(s)\nReps: ${reps} • Lapses: ${lapses}\n\nSession: flips ${state.session.flips}, know ${state.session.knows}, again ${state.session.agains}, stars ${state.session.starsToggled}`;
    }

    function flip() {
      if (!current()) return;
      state.showingBack = !state.showingBack;
      state.session.flips += 1;
      updateUI();
    }

    function next() {
      if (state.index < state.deck.length - 1) {
        state.index += 1;
        state.showingBack = false;
        updateUI();
      }
    }

    function prev() {
      if (state.index > 0) {
        state.index -= 1;
        state.showingBack = false;
        updateUI();
      }
    }

    function shuffleDeck() {
      for (let i = state.deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [state.deck[i], state.deck[j]] = [state.deck[j], state.deck[i]];
      }
      state.index = 0;
      state.showingBack = false;
      updateUI();
    }

    function restartSession() {
      state.index = 0;
      state.showingBack = false;
      state.session.startedAt = Date.now();
      state.session.flips = 0;
      state.session.knows = 0;
      state.session.agains = 0;
      state.session.starsToggled = 0;
      updateUI();
    }

    async function toggleStar() {
      const c = current();
      if (!c) return;
      const currentlyStarred = !!c.p?.starred;
      const newStarred = !currentlyStarred;

      // upsert progress row
      const row = normalizeProgressRow(c, { starred: newStarred });
      const ok = await upsertProgress(row);
      if (!ok) return;

      state.session.starsToggled += 1;
      c.p = { ...(c.p || {}), ...row };
      state.progressMap.set(c.it.id, c.p);
      updateUI();
    }

    // Simple spaced repetition-lite scheduling
    async function markAgain() {
      const c = current();
      if (!c) return;

      state.session.agains += 1;

      const prevInterval = Number(c.p?.interval_days ?? 0);
      const newInterval = 0.25; // 6 hours-ish, feels “soon” without being instant
      const lapses = Number(c.p?.lapses ?? 0) + 1;
      const reps = Number(c.p?.reps ?? 0) + 1;

      const row = normalizeProgressRow(c, {
        last_result: "again",
        reps,
        lapses,
        interval_days: newInterval,
        due_at: addDaysISO(newInterval)
      });

      const ok = await upsertProgress(row);
      if (!ok) return;

      c.p = { ...(c.p || {}), ...row };
      state.progressMap.set(c.it.id, c.p);

      // Auto move on (feels smooth)
      next();
    }

    async function markKnow() {
      const c = current();
      if (!c) return;

      state.session.knows += 1;

      const reps = Number(c.p?.reps ?? 0) + 1;
      const lapses = Number(c.p?.lapses ?? 0);
      const prevInterval = Number(c.p?.interval_days ?? 0);

      // ramp interval: 1 → 2 → 4 → 7 → 14 → 30 (ish)
      let newInterval;
      if (prevInterval < 1) newInterval = 1;
      else if (prevInterval < 2) newInterval = 2;
      else if (prevInterval < 4) newInterval = 4;
      else if (prevInterval < 7) newInterval = 7;
      else if (prevInterval < 14) newInterval = 14;
      else newInterval = Math.min(60, Math.round(prevInterval * 1.8));

      const row = normalizeProgressRow(c, {
        last_result: "know",
        reps,
        lapses,
        interval_days: newInterval,
        due_at: addDaysISO(newInterval)
      });

      const ok = await upsertProgress(row);
      if (!ok) return;

      c.p = { ...(c.p || {}), ...row };
      state.progressMap.set(c.it.id, c.p);

      next();
    }

    function normalizeProgressRow(c, overrides = {}) {
      const base = c.p || {};
      return {
        user_id: state.user.id,
        item_id: c.it.id,
        set_id: state.set.id,
        starred: !!base.starred,
        reps: Number(base.reps ?? 0),
        lapses: Number(base.lapses ?? 0),
        interval_days: Number(base.interval_days ?? 0),
        due_at: base.due_at || null,
        last_result: base.last_result || null,
        updated_at: nowISO(),
        ...overrides
      };
    }

    async function upsertProgress(row) {
      // If table doesn’t exist yet, you’ll see an error here.
      const { error } = await sb
        .from("flashcard_progress")
        .upsert(row, { onConflict: "user_id,item_id" });

      if (error) {
        setStatus("Saving progress failed: " + error.message, "error");
        return false;
      }
      setStatus("Progress saved ✅", "ok");
      // don’t spam — fade back to normal quickly
      setTimeout(() => setStatus("Revising…", "muted"), 800);
      return true;
    }

    // --------- OPEN SET ---------
    async function openSet(setRow) {
      state.set = setRow;

      $("setPicker").classList.add("hidden");
      $("flashView").classList.remove("hidden");
      $("backToSetsBtn").classList.remove("hidden");

      $("activeSetTitle").textContent = setRow.title || "Untitled set";
      $("activeSetMeta").textContent = `Subject: ${setRow.subject || "—"} • Created: ${new Date(setRow.created_at).toLocaleDateString()}`;

      const okItems = await loadSetItems(setRow.id);
      await loadProgress(setRow.id);

      if (!okItems) return;

      if (!state.items.length) {
        setStatus("This set has no cards yet. Add terms in sets.", "muted");
      } else {
        setStatus("Revising…", "ok");
      }

      state.onlyDue = false;
      $("toggleOnlyDueBtn").textContent = "Only due: Off";

      restartSession();
      buildDeck();
      $("flashCard").focus();
    }

    function backToSets() {
      state.set = null;
      state.items = [];
      state.progressMap = new Map();
      state.deck = [];
      state.index = 0;
      state.showingBack = false;

      $("flashView").classList.add("hidden");
      $("setPicker").classList.remove("hidden");
      $("backToSetsBtn").classList.add("hidden");

      setStatus("Pick a set to start flashcards.", "ok");
    }

    // --------- EVENTS ---------
    function bindEvents() {
      $("logoutBtn").addEventListener("click", logout);
      $("setSearch").addEventListener("input", renderSets);

      $("backToSetsBtn").addEventListener("click", backToSets);

      $("flashCard").addEventListener("click", flip);
      $("flipBtn").addEventListener("click", flip);
      $("nextBtn").addEventListener("click", next);
      $("prevBtn").addEventListener("click", prev);

      $("shuffleBtn").addEventListener("click", () => {
        shuffleDeck();
        setStatus("Shuffled ✅", "ok");
        setTimeout(() => setStatus("Revising…", "muted"), 700);
      });

      $("resetSessionBtn").addEventListener("click", () => {
        restartSession();
        setStatus("Restarted ✅", "ok");
        setTimeout(() => setStatus("Revising…", "muted"), 700);
      });

      $("toggleOnlyDueBtn").addEventListener("click", () => {
        state.onlyDue = !state.onlyDue;
        $("toggleOnlyDueBtn").textContent = `Only due: ${state.onlyDue ? "On" : "Off"}`;
        buildDeck();
      });

      $("starBtn").addEventListener("click", toggleStar);
      $("starBadge").addEventListener("click", (e) => { e.stopPropagation(); toggleStar(); });

      $("againBtn").addEventListener("click", markAgain);
      $("knowBtn").addEventListener("click", markKnow);

      // Keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        if ($("flashView").classList.contains("hidden")) return;

        const k = e.key.toLowerCase();
        if (k === " "){ e.preventDefault(); flip(); }
        else if (k === "arrowright"){ next(); }
        else if (k === "arrowleft"){ prev(); }
        else if (k === "k"){ markKnow(); }
        else if (k === "a"){ markAgain(); }
        else if (k === "s"){ toggleStar(); }
        else if (k === "r"){ restartSession(); }
        else if (k === "h"){ shuffleDeck(); }
      });
    }

    // --------- INIT ---------
    (async function init(){
      bindEvents();
      const ok = await requireAuth();
      if (!ok) return;
      await loadSets();
    })();
  </script>
</body>
</html>